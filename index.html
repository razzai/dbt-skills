<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My DBT Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            /* Light Mode (Default) */
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --card-bg: #f7fafc;
            --text-color: #334e68;
            --heading-color: #102a43;
            --accent-color: #5d9cec;
            --accent-light: #e6f0ff;
            --button-bg: #7cb9e8;
            --button-hover: #5d9cec;
            --affirmation-bg: #8c7ae6;
            --affirmation-hover: #7b68e0;
            --delete-button: #e87c7c;
            --delete-hover: #c45b5b;
            --neutral-color: #bcccdc;
            --border-color: #e0e6ed;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode {
            /* Dark Mode */
            --bg-color: #1a202c;
            --container-bg: #2d3748;
            --card-bg: #4a5568;
            --text-color: #e2e8f0;
            --heading-color: #f7fafc;
            --accent-color: #63b3ed;
            --accent-light: #2c5282;
            --button-bg: #4299e1;
            --button-hover: #63b3ed;
            --affirmation-bg: #9f7aea;
            --affirmation-hover: #805ad5;
            --delete-button: #f56565;
            --delete-hover: #c53030;
            --neutral-color: #718096;
            --border-color: #4a5568;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            transition: background-color 0.3s;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1, h2 {
            text-align: center;
            margin: 0;
            font-weight: 700;
            color: var(--heading-color);
            transition: color 0.3s;
        }

        h1 {
            color: var(--accent-color);
            font-size: 2.25rem;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .points-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--affirmation-bg);
            margin-bottom: 24px;
            transition: color 0.3s;
        }
        
        .tool-selection, .emotion-check, .custom-action, .history-log, .reward-system {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .tool-buttons, .specific-tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .tool-button, .button, .breathing-button, .specific-tool-button, .add-reward-button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .button:disabled {
            background-color: var(--neutral-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tool-button:hover, .button:not(:disabled):hover, .breathing-button:hover, .specific-tool-button:hover, .add-reward-button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .tool-button:active, .button:not(:disabled):active, .breathing-button:active, .specific-tool-button:active, .add-reward-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tool-button.selected, .specific-tool-button.selected {
            background-color: var(--affirmation-bg);
        }
        
        .reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--container-bg);
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .reward-details {
            display: flex;
            flex-direction: column;
        }
        
        .reward-name {
            font-weight: 600;
        }
        
        .reward-cost {
            font-size: 0.9rem;
            color: #666;
        }

        .reward-item .button {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
        }
        
        .reward-actions {
            display: flex;
            gap: 8px;
        }

        .delete-reward-button {
            background-color: var(--delete-button);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        .delete-reward-button:hover {
            background-color: var(--delete-hover);
            transform: translateY(-2px);
        }

        .emotion-scale {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .emotion-scale label {
            font-weight: 500;
        }

        .emotion-scale input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--neutral-color);
            border-radius: 4px;
            outline: none;
            transition: opacity .2s;
        }

        .emotion-scale input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .emotion-scale .value-display {
            text-align: center;
            font-weight: 700;
        }

        .box-breathing {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        #breathing-canvas {
            width: 200px;
            height: 200px;
            cursor: pointer;
        }

        .breathing-message {
            font-weight: 500;
            min-height: 20px;
        }

        .affirmation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        .affirmation-face {
            width: 60px;
            height: 60px;
            background-color: var(--affirmation-bg);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .affirmation-face:hover {
            transform: scale(1.05);
            background-color: var(--affirmation-hover);
        }

        .affirmation-message {
            font-weight: 600;
            color: var(--text-color);
            min-height: 20px;
            max-width: 600px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        input[type="text"], textarea, input[type="number"] {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-family: inherit;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .history-log table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-log th, .history-log td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-log th {
            background-color: var(--accent-light);
            font-weight: 700;
        }

        .history-log-message {
            text-align: center;
            font-style: italic;
            color: #666;
        }
        
        .specific-tools-section {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .specific-tools-section.visible {
            display: flex;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 16px;
            text-align: center;
            max-width: 80vw;
        }

        .message-box.visible {
            display: flex;
        }
        
        .message-box-text {
            font-weight: 500;
            font-size: 1.1rem;
            text-align: left;
        }
        
        /* Dark Mode Toggle Switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        @media (max-width: 700px) {
            .history-log table, 
            .history-log thead, 
            .history-log tbody, 
            .history-log th, 
            .history-log td, 
            .history-log tr {
                display: block;
            }

            .history-log thead {
                display: none;
            }

            .history-log tr {
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                margin-bottom: 1rem;
                background-color: var(--container-bg);
            }

            .history-log td {
                border: none;
                border-bottom: 1px solid var(--border-color);
                position: relative;
                padding-left: 50%;
                text-align: right;
                min-height: 2.5em;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            
            .history-log tr td:last-child {
                border-bottom: none;
            }

            .history-log td::before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: calc(50% - 24px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--heading-color);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <h1>My DBT Companion</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>
    <p class="points-display" id="points-display">Points: 0</p>

    <!-- Affirmation Section -->
    <div class="card affirmation-container">
        <h2>Need a Boost?</h2>
        <div class="affirmation-face" id="affirmation-face">ðŸ˜Š</div>
        <p class="affirmation-message" id="affirmation-message">Click the face for a neuro-affirming affirmation.</p>
    </div>
    
    <!-- Box Breathing Section -->
    <div class="card box-breathing">
        <h2>Box Breathing</h2>
        <canvas id="breathing-canvas"></canvas>
        <p class="breathing-message" id="breathing-message">Click below to begin.</p>
        <button class="breathing-button" id="toggle-breathing-button">Start Breathing</button>
    </div>

    <!-- Main Tool/Emotion Logging Section -->
    <div class="card">
        <h2>Log a DBT Tool Session</h2>
        
        <div class="tool-selection">
            <p>1. Select the tool category you used:</p>
            <div class="tool-buttons" id="tool-category-buttons">
                <button class="tool-button" data-tool="Mindfulness">Mindfulness</button>
                <button class="tool-button" data-tool="Emotional Regulation">Emotional Regulation</button>
                <button class="tool-button" data-tool="Distress Tolerance">Distress Tolerance</button>
            </div>
        </div>
        
        <div class="specific-tools-section" id="specific-tools-section">
            <p>2. Select the specific tool you used:</p>
            <div class="specific-tool-buttons" id="specific-tool-buttons"></div>
            <button class="button" id="show-guide-button" disabled>Show Guide</button>
        </div>

        <div class="emotion-check">
            <p>3. How did you feel before and after?</p>
            <div class="emotion-scale">
                <label for="before-emotion">Before Session</label>
                <input type="range" id="before-emotion" min="0" max="100" value="50">
                <p class="value-display" id="before-value">Feeling Score: 50</p>
            </div>
            <div class="emotion-scale">
                <label for="after-emotion">After Session</label>
                <input type="range" id="after-emotion" min="0" max="100" value="50">
                <p class="value-display" id="after-value">Feeling Score: 50</p>
            </div>
        </div>
        <button class="button" id="log-session">Log Session</button>
    </div>

    <!-- Custom Action Section -->
    <div class="card custom-action">
        <h2>Log a Custom Action</h2>
        <form id="custom-action-form">
            <p>What did you do?</p>
            <input type="text" id="custom-action-name" placeholder="E.g., Took a walk" required>
            <p>Add some notes:</p>
            <textarea id="custom-action-notes" placeholder="Any thoughts..."></textarea>
            <button class="button" type="submit">Log Custom Action</button>
        </form>
    </div>

    <!-- Reward System Section -->
    <div class="card reward-system">
        <h2>My Rewards</h2>
        <form id="add-reward-form">
            <input type="text" id="new-reward-name" placeholder="Reward name" required>
            <input type="number" id="new-reward-cost" placeholder="Points cost" min="1" required>
            <button class="add-reward-button" type="submit">Add Reward</button>
        </form>
        <div id="rewards-list">
            <p id="no-rewards-message" style="text-align:center; font-style:italic;">No rewards added yet.</p>
        </div>
    </div>


    <!-- History Log Section -->
    <div class="card history-log">
        <h2>Session History</h2>
        <div class="history-table-container">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Tool</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Score</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
        <button class="button" id="download-history">Download History (CSV)</button>
    </div>
</div>

<!-- Message Box -->
<div class="message-box" id="message-box">
    <p class="message-box-text" id="message-box-text"></p>
    <button class="button" onclick="document.getElementById('message-box').classList.remove('visible')">Close</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements & Global Variables ---
    const themeToggle = document.getElementById('checkbox');
    const pointsDisplay = document.getElementById('points-display');
    const toolCategoryButtons = document.querySelectorAll('.tool-button');
    const specificToolsSection = document.getElementById('specific-tools-section');
    const specificToolButtonsContainer = document.getElementById('specific-tool-buttons');
    const showGuideButton = document.getElementById('show-guide-button');
    const beforeEmotionSlider = document.getElementById('before-emotion');
    const afterEmotionSlider = document.getElementById('after-emotion');
    const beforeValueDisplay = document.getElementById('before-value');
    const afterValueDisplay = document.getElementById('after-value');
    const logSessionButton = document.getElementById('log-session');
    const customActionForm = document.getElementById('custom-action-form');
    const customActionNameInput = document.getElementById('custom-action-name');
    const customActionNotesInput = document.getElementById('custom-action-notes');
    const historyBody = document.getElementById('history-body');
    const downloadHistoryButton = document.getElementById('download-history');
    const affirmationFace = document.getElementById('affirmation-face');
    const breathingCanvas = document.getElementById('breathing-canvas');
    const breathingMessage = document.getElementById('breathing-message');
    const toggleBreathingButton = document.getElementById('toggle-breathing-button');
    const messageBox = document.getElementById('message-box');
    const messageBoxText = document.getElementById('message-box-text');
    const addRewardForm = document.getElementById('add-reward-form');
    const rewardsList = document.getElementById('rewards-list');

    let selectedTool = null;
    let sessionHistory = [];
    let rewards = [];
    let totalPoints = 0;
    let isBreathing = false;
    let breathingIntervalId = null;
    const historyStorageKey = 'dbt-companion-history';
    const rewardsStorageKey = 'dbt-companion-rewards';
    const pointsStorageKey = 'dbt-companion-points';
    const themeStorageKey = 'dbt-companion-theme';

    // --- Data (will be populated later) ---
    const dbtTools = {};
    const dbtToolGuides = {};
    const affirmations = [];

    // --- Three.js Breathing Animation Variables ---
    let scene, camera, renderer, sphere;
    let breathingPhase = 'hold_small'; // inhale, hold_big, exhale, hold_small
    let phaseProgress = 0; // 0 to 1
    const phaseDuration = 4; // seconds
    const clock = new THREE.Clock();
    const minScale = 1.0;
    const maxScale = 1.5;
    const colors = {
        inhale: new THREE.Color(0x63b3ed),     // Blue
        hold_big: new THREE.Color(0x9f7aea),  // Purple
        exhale: new THREE.Color(0x48bb78),    // Green
        hold_small: new THREE.Color(0xa0aec0) // Gray
    };

    // --- Initialization ---
    function initializeApp() {
        populateData();
        loadTheme();
        loadData();
        initThreeJS();
        attachEventListeners();
    }

    // --- Three.js Setup and Animation ---
    function initThreeJS() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, breathingCanvas.clientWidth / breathingCanvas.clientHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ canvas: breathingCanvas, antialias: true, alpha: true });
        renderer.setSize(breathingCanvas.clientWidth, breathingCanvas.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshStandardMaterial({
            color: colors.hold_small,
            metalness: 0.3,
            roughness: 0.4
        });
        sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 0.8);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        camera.position.z = 3;
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        const deltaTime = clock.getDelta();

        if (isBreathing) {
            phaseProgress += deltaTime / phaseDuration;
            
            let currentScale, startColor, endColor;

            switch (breathingPhase) {
                case 'inhale':
                    currentScale = THREE.MathUtils.lerp(minScale, maxScale, phaseProgress);
                    startColor = colors.hold_small;
                    endColor = colors.inhale;
                    break;
                case 'hold_big':
                    currentScale = maxScale;
                    startColor = colors.inhale;
                    endColor = colors.hold_big;
                    break;
                case 'exhale':
                    currentScale = THREE.MathUtils.lerp(maxScale, minScale, phaseProgress);
                    startColor = colors.hold_big;
                    endColor = colors.exhale;
                    break;
                case 'hold_small':
                    currentScale = minScale;
                    startColor = colors.exhale;
                    endColor = colors.hold_small;
                    break;
            }
            
            sphere.scale.set(currentScale, currentScale, currentScale);
            sphere.material.color.lerpColors(startColor, endColor, phaseProgress);
        }
        
        sphere.rotation.y += 0.001;
        renderer.render(scene, camera);
    }
    
    // --- Theme Management ---
    function loadTheme() {
        const isDarkMode = localStorage.getItem(themeStorageKey) === 'true';
        themeToggle.checked = isDarkMode;
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
        }
    }

    function handleThemeToggle() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem(themeStorageKey, themeToggle.checked);
    }

    // --- Core Functions (Data, Rendering, etc.) ---
    function loadData() {
        sessionHistory = JSON.parse(localStorage.getItem(historyStorageKey)) || [];
        rewards = JSON.parse(localStorage.getItem(rewardsStorageKey)) || [];
        totalPoints = parseInt(localStorage.getItem(pointsStorageKey), 10) || 0;
        renderHistory();
        renderRewards();
        updatePointsDisplay();
    }
    
    function saveData() {
        localStorage.setItem(historyStorageKey, JSON.stringify(sessionHistory));
        localStorage.setItem(rewardsStorageKey, JSON.stringify(rewards));
        localStorage.setItem(pointsStorageKey, totalPoints);
    }
    
    function updatePointsDisplay() {
        pointsDisplay.textContent = `Points: ${totalPoints}`;
    }
    
    function calculateScore(tool, before, after) {
        let baseScore = 50;
        if (tool === 'Box Breathing') baseScore = 100;
        const emotionBonus = Math.max(0, after - before);
        return baseScore + emotionBonus;
    }
    
    function renderHistory() {
        if (sessionHistory.length === 0) {
            historyBody.innerHTML = `<tr><td colspan="6" class="history-log-message">No sessions logged yet.</td></tr>`;
            return;
        }
        const html = sessionHistory.map(session => {
            const formattedDate = new Date(session.timestamp).toLocaleString();
            return `
                <tr>
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Tool">${session.tool}</td>
                    <td data-label="Before">${session.beforeEmotion}</td>
                    <td data-label="After">${session.afterEmotion}</td>
                    <td data-label="Score">${session.score}</td>
                    <td data-label="Notes">${session.notes || '-'}</td>
                </tr>
            `;
        }).join('');
        historyBody.innerHTML = html;
    }
    
    function renderRewards() {
        if (rewards.length === 0) {
            rewardsList.innerHTML = `<p id="no-rewards-message" style="text-align:center; font-style:italic;">No rewards added yet.</p>`;
            return;
        }
        rewardsList.innerHTML = '';
        rewards.forEach((reward, index) => {
            const rewardItem = document.createElement('div');
            rewardItem.classList.add('reward-item');
            rewardItem.innerHTML = `
                <div class="reward-details">
                    <span class="reward-name">${reward.name}</span>
                    <span class="reward-cost">Cost: ${reward.cost} points</span>
                </div>
                <div class="reward-actions">
                    <button class="button spend-reward" data-index="${index}">Spend</button>
                    <button class="delete-reward-button" data-index="${index}">Delete</button>
                </div>
            `;
            rewardsList.appendChild(rewardItem);
        });
        document.querySelectorAll('.spend-reward').forEach(b => b.addEventListener('click', spendReward));
        document.querySelectorAll('.delete-reward-button').forEach(b => b.addEventListener('click', deleteReward));
    }
    
    // --- Event Handlers ---
    function handleCategorySelection(event) {
        toolCategoryButtons.forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedCategory = event.target.dataset.tool;
        selectedTool = null;
        showGuideButton.disabled = true;
        renderSpecificTools(selectedCategory);
    }
    
    function renderSpecificTools(category) {
        const tools = dbtTools[category] || [];
        specificToolButtonsContainer.innerHTML = tools.map(tool => `<button class="specific-tool-button" data-tool="${tool}">${tool}</button>`).join('');
        specificToolsSection.classList.add('visible');
        document.querySelectorAll('.specific-tool-button').forEach(button => button.addEventListener('click', handleToolSelection));
    }
    
    function handleToolSelection(event) {
        document.querySelectorAll('.specific-tool-button').forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedTool = event.target.dataset.tool;
        showGuideButton.disabled = false;
    }
    
    function showToolGuide() {
        if (selectedTool && dbtToolGuides[selectedTool]) {
            showMessage(dbtToolGuides[selectedTool], true);
        } else {
            showMessage("Please select a specific tool first to see its guide.", false);
        }
    }
    
    function updateSliderValue(event) {
        const displayElement = event.target.id === 'before-emotion' ? beforeValueDisplay : afterValueDisplay;
        displayElement.textContent = `Feeling Score: ${event.target.value}`;
    }
    
    function logToolSession() {
        if (!selectedTool) {
            showMessage("Please select a specific DBT tool before logging.");
            return;
        }
        const before = parseInt(beforeEmotionSlider.value);
        const after = parseInt(afterEmotionSlider.value);
        const score = calculateScore(selectedTool, before, after);
        totalPoints += score;
        sessionHistory.unshift({
            tool: selectedTool,
            beforeEmotion: before,
            afterEmotion: after,
            score: score,
            notes: '',
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Session logged! You earned a score of ${score}.`);
        
        // Reset form
        toolCategoryButtons.forEach(btn => btn.classList.remove('selected'));
        specificToolsSection.classList.remove('visible');
        selectedCategory = null;
        selectedTool = null;
        showGuideButton.disabled = true;
        beforeEmotionSlider.value = 50;
        afterEmotionSlider.value = 50;
        updateSliderValue({ target: beforeEmotionSlider });
        updateSliderValue({ target: afterEmotionSlider });
    }
    
    function logCustomAction(event) {
        event.preventDefault();
        const actionName = customActionNameInput.value.trim();
        if (!actionName) {
            showMessage("Please enter a name for your custom action.");
            return;
        }
        const notes = customActionNotesInput.value.trim();
        const score = 25;
        totalPoints += score;
        sessionHistory.unshift({
            tool: actionName,
            beforeEmotion: '-',
            afterEmotion: '-',
            score: score,
            notes: notes || '-',
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Custom action logged! You earned a score of ${score}.`);
        customActionForm.reset();
    }
    
    function addReward(event) {
        event.preventDefault();
        const name = newRewardNameInput.value.trim();
        const cost = parseInt(newRewardCostInput.value, 10);
        if (!name || isNaN(cost) || cost <= 0) {
            showMessage("Please enter a valid reward name and a positive points cost.");
            return;
        }
        rewards.push({ name, cost });
        saveData();
        renderRewards();
        showMessage(`Reward "${name}" added!`);
        addRewardForm.reset();
    }
    
    function spendReward(event) {
        const index = event.target.dataset.index;
        const reward = rewards[index];
        if (totalPoints >= reward.cost) {
            totalPoints -= reward.cost;
            saveData();
            updatePointsDisplay();
            showMessage(`You spent ${reward.cost} points on: "${reward.name}". Enjoy your reward!`);
        } else {
            showMessage(`You don't have enough points. You need ${reward.cost}, but you have ${totalPoints}.`);
        }
    }
    
    function deleteReward(event) {
        const index = event.target.dataset.index;
        const rewardName = rewards[index].name;
        rewards.splice(index, 1);
        saveData();
        renderRewards();
        showMessage(`Reward "${rewardName}" has been deleted.`);
    }
    
    function downloadHistory() {
        if (sessionHistory.length === 0) {
            showMessage("No history to download yet!");
            return;
        }
        const headers = ["Timestamp", "Tool", "Before Emotion", "After Emotion", "Score", "Notes"];
        const rows = sessionHistory.map(s => [
            `"${new Date(s.timestamp).toLocaleString()}"`,
            `"${s.tool}"`, `"${s.beforeEmotion}"`, `"${s.afterEmotion}"`, `"${s.score}"`,
            `"${(s.notes || '').replace(/"/g, '""')}"`
        ].join(','));
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "dbt_companion_history.csv";
        link.click();
        URL.revokeObjectURL(link.href);
    }
    
    function toggleBreathing() {
        isBreathing = !isBreathing;
        if (isBreathing) {
            toggleBreathingButton.textContent = "Stop Breathing";
            const phases = ['inhale', 'hold_big', 'exhale', 'hold_small'];
            const messages = ["Inhale...", "Hold...", "Exhale...", "Hold..."];
            let phaseIndex = 0;
            
            const startNextPhase = () => {
                breathingPhase = phases[phaseIndex];
                breathingMessage.textContent = messages[phaseIndex];
                phaseProgress = 0;
                phaseIndex = (phaseIndex + 1) % 4;
            };
            
            startNextPhase();
            breathingIntervalId = setInterval(startNextPhase, phaseDuration * 1000);

        } else {
            toggleBreathingButton.textContent = "Start Breathing";
            clearInterval(breathingIntervalId);
            breathingIntervalId = null;
            breathingPhase = 'hold_small';
            sphere.material.color.set(colors.hold_small);
            sphere.scale.set(minScale, minScale, minScale);
            
            breathingMessage.textContent = "Great job! Session complete.";
            const score = 100;
            totalPoints += score;
            sessionHistory.unshift({
                tool: 'Box Breathing',
                beforeEmotion: '-', afterEmotion: '-', score,
                notes: 'Completed a 3D breathing session.',
                timestamp: new Date().toISOString()
            });
            saveData();
            renderHistory();
            updatePointsDisplay();
            showMessage(`Box breathing session logged. You earned ${score} points!`);
        }
    }
    
    function showAffirmation() {
        const affirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
        showMessage(affirmation);
    }
    
    function showMessage(message, allowHTML = false) {
        messageBoxText[allowHTML ? 'innerHTML' : 'textContent'] = message;
        messageBox.classList.add('visible');
    }

    // --- Attach Event Listeners ---
    function attachEventListeners() {
        themeToggle.addEventListener('change', handleThemeToggle);
        toolCategoryButtons.forEach(button => button.addEventListener('click', handleCategorySelection));
        showGuideButton.addEventListener('click', showToolGuide);
        beforeEmotionSlider.addEventListener('input', updateSliderValue);
        afterEmotionSlider.addEventListener('input', updateSliderValue);
        logSessionButton.addEventListener('click', logToolSession);
        customActionForm.addEventListener('submit', logCustomAction);
        downloadHistoryButton.addEventListener('click', downloadHistory);
        affirmationFace.addEventListener('click', showAffirmation);
        toggleBreathingButton.addEventListener('click', toggleBreathing);
        addRewardForm.addEventListener('submit', addReward);
    }

    function populateData() {
        Object.assign(dbtTools, {
            'Mindfulness': ['Observe', 'Describe', 'Participate', 'One-Mindfully', 'Non-Judgmentally', 'Effectively', 'Wise Mind'],
            'Emotional Regulation': ['CHECK THE FACTS', 'Opposite Action', 'Problem Solving', 'Accumulating Positive Emotions', 'Build Mastery', 'Cope Ahead', 'Vulnerability Reduction'],
            'Distress Tolerance': ['TIP Skill', 'ACCEPTS', 'IMPROVE', 'Pros and Cons', 'Radical Acceptance', 'Turning the Mind']
        });
        Object.assign(dbtToolGuides, {
            'Observe': '<strong>Observe:</strong> Simply notice your experience without getting caught in it. Pay attention to your senses: what you see, hear, smell, taste, and feel. Notice thoughts and feelings as they come and go, like clouds in the sky.',
            'Describe': '<strong>Describe:</strong> Put words to what you observe. Use factual, non-judgmental language.', 'Participate': '<strong>Participate:</strong> Throw yourself completely into the current moment.', 'One-Mindfully': '<strong>One-Mindfully:</strong> Do one thing at a time.', 'Non-Judgmentally': '<strong>Non-Judgmentally:</strong> See things as they are, without labeling them as "good" or "bad."', 'Effectively': '<strong>Effectively:</strong> Focus on what works.', 'Wise Mind': '<strong>Wise Mind:</strong> Find the balance between your emotional mind and your reasonable mind.', 'CHECK THE FACTS': '<strong>CHECK THE FACTS:</strong> When your emotions don\'t fit the facts of a situation, this skill helps you check if your interpretation is correct.', 'Opposite Action': '<strong>Opposite Action:</strong> When you have an unjustified emotion, act opposite to its urge.', 'Problem Solving': '<strong>Problem Solving:</strong> When you have a practical problem, use this skill to find a solution.', 'Accumulating Positive Emotions': '<strong>Accumulating Positive Emotions:</strong> Intentionally do things that bring you joy.', 'Build Mastery': '<strong>Build Mastery:</strong> Do something that makes you feel competent and effective.', 'Cope Ahead': '<strong>Cope Ahead:</strong> Rehearse a difficult situation in your mind ahead of time.', 'Vulnerability Reduction': '<strong>Vulnerability Reduction (PLEASE):</strong> Reduce your vulnerability by taking care of your body.', 'TIP Skill': '<strong>TIP Skill:</strong> Quickly change your body chemistry to reduce extreme emotional arousal.', 'ACCEPTS': '<strong>ACCEPTS:</strong> Distract yourself from painful emotions with healthy activities.', 'IMPROVE': '<strong>IMPROVE the moment:</strong> Soothe yourself in a difficult moment.', 'Pros and Cons': '<strong>Pros and Cons:</strong> Think about the advantages and disadvantages of acting on crisis urges versus resisting them.', 'Radical Acceptance': '<strong>Radical Acceptance:</strong> Completely and totally accept reality as it is.', 'Turning the Mind': '<strong>Turning the Mind:</strong> Make a conscious choice to turn your mind toward acceptance.'
        });
        affirmations.push(...[
            "Your feelings are valid, no matter what they are.", "It's okay to need a break. You are not lazy.", "Your unique way of processing the world is a strength.", "You are worthy of love and acceptance just as you are.", "Sensory overload is a real thing, and it's okay to step away.", "Your intuition about what you need is powerful. Listen to it.", "You don't have to 'mask' to be loved or valued.", "Progress isn't always linear, and that's perfectly normal.", "Your brain works differently, and that's a beautiful thing.", "Rest is productive. Your body and mind need it.", "You are not broken. You are a complete, whole person."
        ]);
    }

    // Initial load
    initializeApp();
});
</script>

</body>
</html>
