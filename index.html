<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Life Worth Living</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            /* Light Mode (Default) */
            --bg-color: #f0f4f8;
            --container-bg: rgba(255, 255, 255, 0.85);
            --card-bg: rgba(247, 250, 252, 0.85);
            --text-color: #334e68;
            --heading-color: #102a43;
            --accent-color: #5d9cec;
            --accent-light: #e6f0ff;
            --button-bg: #7cb9e8;
            --button-hover: #5d9cec;
            --affirmation-bg: #8c7ae6;
            --affirmation-hover: #7b68e0;
            --delete-button: #e87c7c;
            --delete-hover: #c45b5b;
            --neutral-color: #bcccdc;
            --border-color: #e0e6ed;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode {
            /* Dark Mode */
            --bg-color: #1a202c;
            --container-bg: rgba(45, 55, 72, 0.85);
            --card-bg: rgba(74, 85, 104, 0.85);
            --text-color: #e2e8f0;
            --heading-color: #f7fafc;
            --accent-color: #63b3ed;
            --accent-light: #2c5282;
            --button-bg: #4299e1;
            --button-hover: #63b3ed;
            --affirmation-bg: #9f7aea;
            --affirmation-hover: #805ad5;
            --delete-button: #f56565;
            --delete-hover: #c53030;
            --neutral-color: #718096;
            --border-color: #4a5568;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            padding-bottom: 100px; /* Space for bottom nav */
            box-sizing: border-box;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .container {
            width: 100%;
            max-width: 800px;
            z-index: 1;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 24px;
        }

        h1, h2, h3 {
            text-align: center;
            margin: 0;
            font-weight: 700;
            color: var(--heading-color);
            transition: color 0.3s;
        }

        h1 {
            color: var(--accent-color);
            font-size: 2.25rem;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
        }
        
        h3 {
            font-size: 1.2rem;
            margin-top: 16px;
            margin-bottom: 8px;
            text-align: left;
        }

        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .points-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--affirmation-bg);
            margin-bottom: 24px;
            transition: color 0.3s;
        }
        
        .tool-selection, .emotion-check, .custom-action, .history-log, .reward-system {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .tool-buttons, .specific-tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .tool-button, .button, .breathing-button, .specific-tool-button, .add-reward-button, .delete-session-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .button:disabled {
            background-color: var(--neutral-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tool-button:hover, .button:not(:disabled):hover, .breathing-button:hover, .specific-tool-button:hover, .add-reward-button:hover, .delete-session-btn:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .tool-button:active, .button:not(:disabled):active, .breathing-button:active, .specific-tool-button:active, .add-reward-button:active, .delete-session-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .delete-session-btn {
            background-color: var(--delete-button);
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        .delete-session-btn:hover {
             background-color: var(--delete-hover);
        }

        .tool-button.selected, .specific-tool-button.selected {
            background-color: var(--affirmation-bg);
        }
        
        .reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--container-bg);
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .reward-details {
            display: flex;
            flex-direction: column;
        }
        
        .reward-name {
            font-weight: 600;
        }
        
        .reward-cost {
            font-size: 0.9rem;
            color: #666;
        }

        .reward-item .button {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
        }
        
        .reward-actions {
            display: flex;
            gap: 8px;
        }

        .delete-reward-button {
            background-color: var(--delete-button);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        .delete-reward-button:hover {
            background-color: var(--delete-hover);
            transform: translateY(-2px);
        }

        .emotion-scale {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .emotion-scale label {
            font-weight: 500;
        }

        .emotion-scale input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--neutral-color);
            border-radius: 4px;
            outline: none;
            transition: opacity .2s;
        }

        .emotion-scale input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .emotion-scale .value-display {
            text-align: center;
            font-weight: 700;
        }

        .box-breathing {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        #breathing-canvas {
            width: 200px;
            height: 200px;
            cursor: pointer;
        }

        .breathing-message {
            font-weight: 500;
            min-height: 20px;
        }

        .affirmation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        .affirmation-face {
            width: 60px;
            height: 60px;
            background-color: var(--affirmation-bg);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .affirmation-face:hover {
            transform: scale(1.05);
            background-color: var(--affirmation-hover);
        }

        .affirmation-message {
            font-weight: 600;
            color: var(--text-color);
            min-height: 20px;
            max-width: 600px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        input[type="text"], textarea, input[type="number"] {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-family: inherit;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        .list-form-inputs {
            display: flex;
            gap: 8px;
        }
        .list-form-inputs input[type="text"] {
            flex-grow: 1;
        }
        .list-form-inputs input[type="number"] {
            width: 80px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .history-log table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-log th, .history-log td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-log th {
            background-color: var(--accent-light);
            font-weight: 700;
        }

        .history-log-message {
            text-align: center;
            font-style: italic;
            color: #666;
        }
        
        .specific-tools-section {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .specific-tools-section.visible {
            display: flex;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 16px;
            text-align: center;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .message-box.visible {
            display: flex;
        }
        
        .message-box-text {
            font-weight: 500;
            font-size: 1.1rem;
            text-align: left;
        }
        
        /* Dark Mode Toggle Switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* Swiper Styles */
        .swiper-container {
            overflow: hidden;
            width: 100%;
        }
        .swiper-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }
        .swiper-panel {
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .swiper-dots {
            text-align: center;
            margin-top: 16px;
        }
        .dot {
            height: 12px;
            width: 12px;
            margin: 0 5px;
            background-color: var(--neutral-color);
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .dot.active {
            background-color: var(--accent-color);
        }
        #list-swiper-track { width: 300%; }
        #list-swiper-track > .swiper-panel { width: 33.333%; }


        /* List Styles */
        .list ul {
            list-style: none;
            padding: 0;
        }
        .list li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--container-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .list li.completed {
            opacity: 0.6;
        }
        .list li.completed span {
            text-decoration: line-through;
        }
        .list li span {
            flex-grow: 1;
        }
        .list input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .list-delete-btn {
            background: var(--delete-button);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            line-height: 24px;
        }
        .list-delete-btn:hover {
            background: var(--delete-hover);
        }
        #view-all-completed-btn {
            margin-top: 16px;
        }
        
        .journal-prompt {
            font-style: italic;
            margin-bottom: 16px;
            padding: 12px;
            background-color: var(--accent-light);
            border-left: 4px solid var(--accent-color);
            border-radius: 4px;
        }
        
        .backup-restore-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        #backup-reminder {
            display: none;
            padding: 16px;
            background-color: var(--accent-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--accent-color);
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        #backup-reminder-buttons {
            display: flex;
            gap: 12px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--container-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        .nav-btn {
            background: none;
            border: none;
            color: var(--neutral-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .nav-btn.active {
            color: var(--accent-color);
        }
        .nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .app-section {
            display: none;
            flex-direction: column;
            gap: 24px; /* This restores the space between cards */
        }
        .app-section.active {
            display: flex;
        }

        @media (max-width: 700px) {
            .history-log table, 
            .history-log thead, 
            .history-log tbody, 
            .history-log th, 
            .history-log td, 
            .history-log tr {
                display: block;
            }

            .history-log thead {
                display: none;
            }

            .history-log tr {
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                margin-bottom: 1rem;
                background-color: var(--container-bg);
            }

            .history-log td {
                border: none;
                border-bottom: 1px solid var(--border-color);
                position: relative;
                padding-left: 50%;
                text-align: right;
                min-height: 2.5em;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            
            .history-log tr td:last-child {
                border-bottom: none;
            }

            .history-log td::before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: calc(50% - 24px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--heading-color);
            }
        }
    </style>
</head>
<body>
<canvas id="background-canvas"></canvas>
<div class="container">
    <div class="header-container">
        <h1>A Life Worth Living</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>
    
    <div id="backup-reminder">
        <p>It's been a while since your last backup. Would you like to save your progress now?</p>
        <div id="backup-reminder-buttons">
            <button class="button" id="backup-reminder-btn">Backup Now</button>
            <button class="button" id="dismiss-reminder-btn">Dismiss</button>
        </div>
    </div>

    <p class="points-display" id="points-display">Points: 0</p>

    <!-- App Sections -->
    <main id="main-content">
        <section id="home" class="app-section">
            <!-- Affirmation Section -->
            <div class="card affirmation-container">
                <h2>Need a Boost?</h2>
                <div class="affirmation-face" id="affirmation-face">ðŸ˜Š</div>
                <p class="affirmation-message" id="affirmation-message">Click the face for a neuro-affirming affirmation.</p>
            </div>
            
            <!-- Box Breathing Section -->
            <div class="card box-breathing">
                <h2>Box Breathing</h2>
                <canvas id="breathing-canvas"></canvas>
                <p class="breathing-message" id="breathing-message">Click below to begin.</p>
                <button class="breathing-button" id="toggle-breathing-button">Start Breathing</button>
            </div>

            <!-- Main Tool/Emotion Logging Section -->
            <div class="card">
                <h2>Log a DBT Tool Session</h2>
                <div class="tool-selection">
                    <p>1. Select the tool category you used:</p>
                    <div class="tool-buttons" id="tool-category-buttons">
                        <button class="tool-button" data-tool="Mindfulness">Mindfulness</button>
                        <button class="tool-button" data-tool="Emotional Regulation">Emotional Regulation</button>
                        <button class="tool-button" data-tool="Distress Tolerance">Distress Tolerance</button>
                    </div>
                </div>
                <div class="specific-tools-section" id="specific-tools-section">
                    <p>2. Select the specific tool you used:</p>
                    <div class="specific-tool-buttons" id="specific-tool-buttons"></div>
                    <button class="button" id="show-guide-button" disabled>Show Guide</button>
                </div>
                <div class="emotion-check">
                    <p>3. How did you feel before and after?</p>
                    <div class="emotion-scale">
                        <label for="before-emotion">Before Session</label>
                        <input type="range" id="before-emotion" min="0" max="100" value="50">
                        <p class="value-display" id="before-value">Feeling Score: 50</p>
                    </div>
                    <div class="emotion-scale">
                        <label for="after-emotion">After Session</label>
                        <input type="range" id="after-emotion" min="0" max="100" value="50">
                        <p class="value-display" id="after-value">Feeling Score: 50</p>
                    </div>
                </div>
                <p>4. Add some notes (optional):</p>
                <textarea id="session-notes" placeholder="Any thoughts, feelings, or observations..."></textarea>
                <button class="button" id="log-session" style="margin-top: 16px;">Log Session</button>
            </div>

            <!-- Custom Action Section -->
            <div class="card custom-action">
                <h2>Log a Custom Action</h2>
                <form id="custom-action-form">
                    <p>What did you do?</p>
                    <input type="text" id="custom-action-name" placeholder="E.g., Took a walk" required>
                    <p>Add some notes:</p>
                    <textarea id="custom-action-notes" placeholder="Any thoughts..."></textarea>
                    <button class="button" type="submit">Log Custom Action</button>
                </form>
            </div>
        </section>

        <section id="lists" class="app-section">
            <!-- Lists Section (Swiper) -->
            <div class="card list">
                <h2 id="list-title">To-Do List</h2>
                <div id="list-swiper" class="swiper-container" data-title-id="list-title">
                    <div id="list-swiper-track" class="swiper-track">
                        <!-- Panel 1: To-Do List -->
                        <div class="swiper-panel">
                            <form id="todo-form">
                                <div class="list-form-inputs">
                                    <input type="text" id="todo-input" placeholder='E.g., "Wash one dish"' required>
                                    <input type="number" id="todo-points" placeholder="10" min="0">
                                </div>
                                <button class="button" type="submit" style="width: 100%; margin-top: 8px;">Add Task</button>
                            </form>
                            <h3>To Do</h3>
                            <ul id="pending-tasks"></ul>
                            <h3>Completed (Last 10)</h3>
                            <ul id="completed-tasks"></ul>
                            <button class="button" id="view-all-completed-btn" style="display:none;">View All Completed</button>
                        </div>
                        <!-- Panel 2: Goals -->
                        <div class="swiper-panel">
                            <form id="goal-form">
                                <div class="list-form-inputs">
                                    <input type="text" id="goal-input" placeholder='E.g., "Practice mindfulness for 5 mins"' required>
                                    <input type="number" id="goal-points" placeholder="15" min="0">
                                </div>
                                <button class="button" type="submit" style="width: 100%; margin-top: 8px;">Add Goal</button>
                            </form>
                            <h3>In Progress</h3>
                            <ul id="pending-goals"></ul>
                            <h3>Achieved</h3>
                            <ul id="completed-goals"></ul>
                        </div>
                        <!-- Panel 3: Grocery List -->
                        <div class="swiper-panel">
                            <form id="grocery-form">
                                <input type="text" id="grocery-input" placeholder='E.g., "Apples"' required>
                                <button class="button" type="submit" style="width: 100%; margin-top: 8px;">Add Item</button>
                            </form>
                            <h3>Needed</h3>
                            <ul id="pending-groceries"></ul>
                            <h3>In Cart</h3>
                            <ul id="completed-groceries"></ul>
                        </div>
                    </div>
                </div>
                <div id="list-swiper-dots" class="swiper-dots">
                    <span class="dot active" data-index="0"></span>
                    <span class="dot" data-index="1"></span>
                    <span class="dot" data-index="2"></span>
                </div>
            </div>
        </section>

        <section id="journal" class="app-section">
             <!-- Journal Section -->
            <div class="card">
                <h2>Daily Stoic Journal</h2>
                <p id="journal-prompt" class="journal-prompt"></p>
                <textarea id="journal-entry" rows="8" placeholder="Your reflections..."></textarea>
                <button class="button" id="save-journal-btn" style="width:100%; margin-top: 8px;">Save Journal Entry</button>
                <button class="button" id="view-journal-history-btn" style="width:100%; margin-top: 8px;">View Past Entries</button>
            </div>
        </section>

        <section id="settings" class="app-section">
            <!-- Reward System Section -->
            <div class="card reward-system">
                <h2>My Rewards</h2>
                <form id="add-reward-form">
                    <input type="text" id="new-reward-name" placeholder="Reward name" required>
                    <input type="number" id="new-reward-cost" placeholder="Points cost" min="1" required>
                    <button class="add-reward-button" type="submit">Add Reward</button>
                </form>
                <div id="rewards-list">
                    <p id="no-rewards-message" style="text-align:center; font-style:italic;">No rewards added yet.</p>
                </div>
            </div>

            <!-- History Log Section -->
            <div class="card history-log">
                <h2>Session History</h2>
                <div class="history-table-container">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Tool</th>
                                <th>Before</th>
                                <th>After</th>
                                <th>Score</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
                <button class="button" id="download-history">Download History (CSV)</button>
            </div>

            <!-- Backup & Restore Section -->
            <div class="card">
                <h2>Backup & Restore</h2>
                <p>Save your progress to a file or restore it from a backup.</p>
                <div class="backup-restore-buttons">
                    <button class="button" id="backup-data-btn">Backup Data</button>
                    <button class="button" id="restore-data-btn">Restore Data</button>
                    <input type="file" id="restore-file-input" style="display: none;" accept=".json">
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Message Box -->
<div class="message-box" id="message-box">
    <p class="message-box-text" id="message-box-text"></p>
    <button class="button" onclick="document.getElementById('message-box').classList.remove('visible')">Close</button>
</div>

<nav class="bottom-nav">
    <button class="nav-btn active" data-section="home">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
    </button>
    <button class="nav-btn" data-section="lists">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-12v2h14V7H7z"/></svg>
        <span>Lists</span>
    </button>
    <button class="nav-btn" data-section="journal">
        <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
        <span>Journal</span>
    </button>
    <button class="nav-btn" data-section="settings">
        <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
        <span>Settings</span>
    </button>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements & Global Variables ---
    const themeToggle = document.getElementById('checkbox');
    const pointsDisplay = document.getElementById('points-display');
    const toolCategoryButtons = document.querySelectorAll('.tool-button');
    const specificToolsSection = document.getElementById('specific-tools-section');
    const specificToolButtonsContainer = document.getElementById('specific-tool-buttons');
    const showGuideButton = document.getElementById('show-guide-button');
    const beforeEmotionSlider = document.getElementById('before-emotion');
    const afterEmotionSlider = document.getElementById('after-emotion');
    const beforeValueDisplay = document.getElementById('before-value');
    const afterValueDisplay = document.getElementById('after-value');
    const logSessionButton = document.getElementById('log-session');
    const sessionNotesInput = document.getElementById('session-notes');
    const customActionForm = document.getElementById('custom-action-form');
    const customActionNameInput = document.getElementById('custom-action-name');
    const customActionNotesInput = document.getElementById('custom-action-notes');
    const historyBody = document.getElementById('history-body');
    const downloadHistoryButton = document.getElementById('download-history');
    const affirmationFace = document.getElementById('affirmation-face');
    const breathingCanvas = document.getElementById('breathing-canvas');
    const breathingMessage = document.getElementById('breathing-message');
    const toggleBreathingButton = document.getElementById('toggle-breathing-button');
    const messageBox = document.getElementById('message-box');
    const messageBoxText = document.getElementById('message-box-text');
    const addRewardForm = document.getElementById('add-reward-form');
    const newRewardNameInput = document.getElementById('new-reward-name');
    const newRewardCostInput = document.getElementById('new-reward-cost');
    const rewardsList = document.getElementById('rewards-list');
    
    // List Swiper Elements
    const listTitle = document.getElementById('list-title');
    const listSwiperContainer = document.getElementById('list-swiper');
    const listSwiperTrack = document.getElementById('list-swiper-track');
    const listSwiperDots = document.querySelectorAll('#list-swiper-dots .dot');
    const todoForm = document.getElementById('todo-form');
    const todoInput = document.getElementById('todo-input');
    const todoPointsInput = document.getElementById('todo-points');
    const pendingTasksList = document.getElementById('pending-tasks');
    const completedTasksList = document.getElementById('completed-tasks');
    const viewAllCompletedBtn = document.getElementById('view-all-completed-btn');
    const goalForm = document.getElementById('goal-form');
    const goalInput = document.getElementById('goal-input');
    const goalPointsInput = document.getElementById('goal-points');
    const pendingGoalsList = document.getElementById('pending-goals');
    const completedGoalsList = document.getElementById('completed-goals');
    const groceryForm = document.getElementById('grocery-form');
    const groceryInput = document.getElementById('grocery-input');
    const pendingGroceriesList = document.getElementById('pending-groceries');
    const completedGroceriesList = document.getElementById('completed-groceries');
    
    // Journal Elements
    const journalPromptEl = document.getElementById('journal-prompt');
    const journalEntryInput = document.getElementById('journal-entry');
    const saveJournalBtn = document.getElementById('save-journal-btn');
    const viewJournalHistoryBtn = document.getElementById('view-journal-history-btn');

    // Backup & Restore Elements
    const backupBtn = document.getElementById('backup-data-btn');
    const restoreBtn = document.getElementById('restore-data-btn');
    const restoreFileInput = document.getElementById('restore-file-input');
    const backupReminder = document.getElementById('backup-reminder');
    const backupReminderBtn = document.getElementById('backup-reminder-btn');
    const dismissReminderBtn = document.getElementById('dismiss-reminder-btn');

    // Navigation Elements
    const navButtons = document.querySelectorAll('.nav-btn');
    const appSections = document.querySelectorAll('.app-section');
    const backgroundCanvas = document.getElementById('background-canvas');

    let selectedTool = null;
    let sessionHistory = [];
    let rewards = [];
    let todoList = [], goalsList = [], groceryList = [];
    let totalPoints = 0;
    let isBreathing = false;
    let breathingIntervalId = null;
    let breathingCycleCount = 0;

    const historyStorageKey = 'dbt-companion-history';
    const rewardsStorageKey = 'dbt-companion-rewards';
    const pointsStorageKey = 'dbt-companion-points';
    const themeStorageKey = 'dbt-companion-theme';
    const todoStorageKey = 'dbt-companion-todo';
    const goalsStorageKey = 'dbt-companion-goals';
    const groceryStorageKey = 'dbt-companion-grocery';
    const lastBackupStorageKey = 'dbt-companion-last-backup';

    const dbtTools = {};
    const dbtToolGuides = {};
    const affirmations = [];
    const stoicPrompts = [];

    // --- Three.js Variables ---
    let scene, camera, renderer, sphere;
    let bgScene, bgCamera, bgRenderer, bgPlane;
    let bgUniforms;
    let breathingPhase = 'hold_small'; 
    let phaseProgress = 0; 
    const phaseDuration = 4; 
    const clock = new THREE.Clock();
    const minScale = 1.0;
    const maxScale = 1.5;
    const colors = {
        inhale: new THREE.Color(0x63b3ed),
        hold_big: new THREE.Color(0x9f7aea),
        exhale: new THREE.Color(0x48bb78),
        hold_small: new THREE.Color(0xa0aec0)
    };

    // --- Initialization ---
    function initializeApp() {
        populateData();
        initBackgroundAnimation(); // Initialize background first
        loadTheme();
        loadData();
        showSection('home');
        initThreeJS();
        displayDailyPrompt();
        checkBackupReminder();
        attachEventListeners();
    }

    // --- Navigation ---
    function showSection(sectionId) {
        appSections.forEach(section => {
            section.classList.toggle('active', section.id === sectionId);
        });
        navButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.section === sectionId);
        });
        window.scrollTo(0, 0);
    }

    // --- Three.js Setup and Animation ---
    function initThreeJS() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, breathingCanvas.clientWidth / breathingCanvas.clientHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ canvas: breathingCanvas, antialias: true, alpha: true });
        renderer.setSize(breathingCanvas.clientWidth, breathingCanvas.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshStandardMaterial({ color: colors.hold_small, metalness: 0.3, roughness: 0.4 });
        sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 0.8);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);
        camera.position.z = 3;
        animate();
    }
    
    function initBackgroundAnimation() {
        bgScene = new THREE.Scene();
        bgCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 10);
        bgRenderer = new THREE.WebGLRenderer({ canvas: backgroundCanvas, antialias: true });
        bgRenderer.setSize(window.innerWidth, window.innerHeight);
        bgRenderer.setPixelRatio(window.devicePixelRatio);

        bgUniforms = {
            u_time: { type: 'f', value: 1.0 },
            u_resolution: { type: 'v2', value: new THREE.Vector2() },
            u_color1: { type: 'c', value: new THREE.Color(0x5d9cec) },
            u_color2: { type: 'c', value: new THREE.Color(0x7cb9e8) },
        };

        const bgGeometry = new THREE.PlaneGeometry(2, 2);
        const bgMaterial = new THREE.ShaderMaterial({
            uniforms: bgUniforms,
            vertexShader: `void main() { gl_Position = vec4(position, 1.0); }`,
            fragmentShader: `
                uniform vec2 u_resolution;
                uniform float u_time;
                uniform vec3 u_color1;
                uniform vec3 u_color2;
                void main() {
                    vec2 st = gl_FragCoord.xy/u_resolution.xy;
                    float time = u_time * 0.1;
                    vec2 p = st * 5.0 - vec2(10.0);
                    vec2 i = p;
                    float c = 1.0;
                    float inten = .05;
                    for (int n = 0; n < 5; n++) {
                        float t = time * (1.0 - (3.0 / float(n+1)));
                        i = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));
                        c += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));
                    }
                    c /= 5.0;
                    c = 1.5 - sqrt(c);
                    vec3 color = mix(u_color1, u_color2, smoothstep(0.0, 1.0, c));
                    gl_FragColor = vec4(color, 1.0);
                }`
        });

        bgPlane = new THREE.Mesh(bgGeometry, bgMaterial);
        bgScene.add(bgPlane);
        bgCamera.position.z = 1;

        onWindowResize();
        window.addEventListener('resize', onWindowResize, false);
        animateBackground();
    }
    
    function onWindowResize() {
        bgRenderer.setSize(window.innerWidth, window.innerHeight);
        bgUniforms.u_resolution.value.x = bgRenderer.domElement.width;
        bgUniforms.u_resolution.value.y = bgRenderer.domElement.height;
    }

    function animate() {
        requestAnimationFrame(animate);
        const deltaTime = clock.getDelta();
        if (isBreathing) {
            phaseProgress += deltaTime / phaseDuration;
            if (phaseProgress >= 1.0) {
                phaseProgress -= 1.0; // Use remainder for smooth transition
                phaseIndex = (phaseIndex + 1) % 4;
                breathingPhase = phases[phaseIndex];
                
                if (phaseIndex === 0) { // A new cycle begins with 'inhale'
                    breathingCycleCount++;
                }
                breathingMessage.textContent = `${messages[phaseIndex]} (Cycle: ${breathingCycleCount})`;
            }
            let currentScale, startColor, endColor;
            switch (breathingPhase) {
                case 'inhale': currentScale = THREE.MathUtils.lerp(minScale, maxScale, phaseProgress); startColor = colors.hold_small; endColor = colors.inhale; break;
                case 'hold_big': currentScale = maxScale; startColor = colors.inhale; endColor = colors.hold_big; break;
                case 'exhale': currentScale = THREE.MathUtils.lerp(maxScale, minScale, phaseProgress); startColor = colors.hold_big; endColor = colors.exhale; break;
                case 'hold_small': currentScale = minScale; startColor = colors.exhale; endColor = colors.hold_small; break;
            }
            sphere.scale.set(currentScale, currentScale, currentScale);
            sphere.material.color.lerpColors(startColor, endColor, phaseProgress);
        }
        sphere.rotation.y += 0.001;
        renderer.render(scene, camera);
    }
    
    function animateBackground() {
        requestAnimationFrame(animateBackground);
        bgUniforms.u_time.value += 0.01; // Slowed down for subtlety
        bgRenderer.render(bgScene, bgCamera);
    }
    
    // --- Theme Management ---
    function loadTheme() {
        // Default to dark mode unless light mode is explicitly saved
        const isLightMode = localStorage.getItem(themeStorageKey) === 'false';
        if (!isLightMode) {
            document.body.classList.add('dark-mode');
            themeToggle.checked = true;
            bgUniforms.u_color1.value.set(0x1a202c);
            bgUniforms.u_color2.value.set(0x2c5282);
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.checked = false;
            bgUniforms.u_color1.value.set(0x5d9cec);
            bgUniforms.u_color2.value.set(0x7cb9e8);
        }
    }

    function handleThemeToggle() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem(themeStorageKey, themeToggle.checked);
        if (themeToggle.checked) {
            bgUniforms.u_color1.value.set(0x1a202c);
            bgUniforms.u_color2.value.set(0x2c5282);
        } else {
            bgUniforms.u_color1.value.set(0x5d9cec);
            bgUniforms.u_color2.value.set(0x7cb9e8);
        }
    }

    // --- Core Functions (Data, Rendering, etc.) ---
    function loadData() {
        sessionHistory = JSON.parse(localStorage.getItem(historyStorageKey)) || [];
        rewards = JSON.parse(localStorage.getItem(rewardsStorageKey)) || [];
        todoList = JSON.parse(localStorage.getItem(todoStorageKey)) || [];
        goalsList = JSON.parse(localStorage.getItem(goalsStorageKey)) || [];
        groceryList = JSON.parse(localStorage.getItem(groceryStorageKey)) || [];
        totalPoints = parseInt(localStorage.getItem(pointsStorageKey), 10) || 0;
        renderHistory();
        renderRewards();
        renderAllLists();
        updatePointsDisplay();
    }
    
    function saveData() {
        localStorage.setItem(historyStorageKey, JSON.stringify(sessionHistory));
        localStorage.setItem(rewardsStorageKey, JSON.stringify(rewards));
        localStorage.setItem(pointsStorageKey, totalPoints);
        localStorage.setItem(todoStorageKey, JSON.stringify(todoList));
        localStorage.setItem(goalsStorageKey, JSON.stringify(goalsList));
        localStorage.setItem(groceryStorageKey, JSON.stringify(groceryList));
    }
    
    function updatePointsDisplay() {
        pointsDisplay.textContent = `Points: ${totalPoints}`;
    }
    
    function calculateScore(tool, before, after) {
        let baseScore = 50;
        if (tool === 'Box Breathing') baseScore = 25;
        if (tool === 'Journal Entry') baseScore = 25;
        const emotionBonus = Math.max(0, after - before);
        return baseScore + emotionBonus;
    }
    
    function renderHistory() {
        if (sessionHistory.length === 0) {
            historyBody.innerHTML = `<tr><td colspan="7" class="history-log-message">No sessions logged yet.</td></tr>`;
            return;
        }
        const html = sessionHistory.map(session => {
            const formattedDate = new Date(session.timestamp).toLocaleString();
            return `
                <tr>
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Tool">${session.tool}</td>
                    <td data-label="Before">${session.beforeEmotion}</td>
                    <td data-label="After">${session.afterEmotion}</td>
                    <td data-label="Score">${session.score}</td>
                    <td data-label="Notes">${session.notes || '-'}</td>
                    <td data-label="Actions"><button class="delete-session-btn" data-timestamp="${session.timestamp}">Delete</button></td>
                </tr>
            `;
        }).join('');
        historyBody.innerHTML = html;
    }
    
    function renderRewards() {
        if (rewards.length === 0) {
            rewardsList.innerHTML = `<p id="no-rewards-message" style="text-align:center; font-style:italic;">No rewards added yet.</p>`;
            return;
        }
        rewardsList.innerHTML = '';
        rewards.forEach((reward, index) => {
            const rewardItem = document.createElement('div');
            rewardItem.classList.add('reward-item');
            rewardItem.innerHTML = `
                <div class="reward-details">
                    <span class="reward-name">${reward.name}</span>
                    <span class="reward-cost">Cost: ${reward.cost} points</span>
                </div>
                <div class="reward-actions">
                    <button class="button spend-reward" data-index="${index}">Spend</button>
                    <button class="delete-reward-button" data-index="${index}">Delete</button>
                </div>
            `;
            rewardsList.appendChild(rewardItem);
        });
        document.querySelectorAll('.spend-reward').forEach(b => b.addEventListener('click', spendReward));
        document.querySelectorAll('.delete-reward-button').forEach(b => b.addEventListener('click', deleteReward));
    }

    function renderAllLists() {
        renderList(pendingTasksList, completedTasksList, todoList, true);
        renderList(pendingGoalsList, completedGoalsList, goalsList, false);
        renderList(pendingGroceriesList, completedGroceriesList, groceryList, false);
    }

    function renderList(pendingUl, completedUl, list, isTodoList) {
        pendingUl.innerHTML = '';
        completedUl.innerHTML = '';
        
        const pending = list.filter(item => !item.completed);
        const completed = list.filter(item => item.completed)
                              .sort((a, b) => new Date(b.completionTimestamp) - new Date(a.completionTimestamp));

        pending.forEach(item => {
            const li = createListItem(item);
            pendingUl.appendChild(li);
        });

        const itemsToShow = isTodoList ? completed.slice(0, 10) : completed;
        itemsToShow.forEach(item => {
            const li = createListItem(item);
            completedUl.appendChild(li);
        });

        if (isTodoList) {
            viewAllCompletedBtn.style.display = completed.length > 10 ? 'block' : 'none';
        }
    }

    function createListItem(item) {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.innerHTML = `
            <input type="checkbox" ${item.completed ? 'checked' : ''}>
            <span>${item.text} ${item.points ? `(${item.points} pts)` : ''}</span>
            <button class="list-delete-btn">X</button>
        `;
        if (item.completed) {
            li.classList.add('completed');
        }
        return li;
    }
    
    // --- Event Handlers ---
    function handleCategorySelection(event) {
        toolCategoryButtons.forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedCategory = event.target.dataset.tool;
        selectedTool = null;
        showGuideButton.disabled = true;
        renderSpecificTools(selectedCategory);
    }
    
    function renderSpecificTools(category) {
        const tools = dbtTools[category] || [];
        specificToolButtonsContainer.innerHTML = tools.map(tool => `<button class="specific-tool-button" data-tool="${tool}">${tool}</button>`).join('');
        specificToolsSection.classList.add('visible');
        document.querySelectorAll('.specific-tool-button').forEach(button => button.addEventListener('click', handleToolSelection));
    }
    
    function handleToolSelection(event) {
        document.querySelectorAll('.specific-tool-button').forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedTool = event.target.dataset.tool;
        showGuideButton.disabled = false;
    }
    
    function showToolGuide() {
        if (selectedTool && dbtToolGuides[selectedTool]) {
            showMessage(dbtToolGuides[selectedTool], true);
        } else {
            showMessage("Please select a specific tool first to see its guide.", false);
        }
    }
    
    function updateSliderValue(event) {
        const displayElement = event.target.id === 'before-emotion' ? beforeValueDisplay : afterValueDisplay;
        displayElement.textContent = `Feeling Score: ${event.target.value}`;
    }
    
    function logToolSession() {
        if (!selectedTool) {
            showMessage("Please select a specific DBT tool before logging.");
            return;
        }
        const before = parseInt(beforeEmotionSlider.value);
        const after = parseInt(afterEmotionSlider.value);
        const notes = sessionNotesInput.value.trim();
        const score = calculateScore(selectedTool, before, after);
        totalPoints += score;
        sessionHistory.unshift({
            tool: selectedTool,
            beforeEmotion: before,
            afterEmotion: after,
            score: score,
            notes: notes || '-',
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Session logged! You earned a score of ${score}.`);
        
        // Reset form
        toolCategoryButtons.forEach(btn => btn.classList.remove('selected'));
        specificToolsSection.classList.remove('visible');
        selectedCategory = null;
        selectedTool = null;
        showGuideButton.disabled = true;
        beforeEmotionSlider.value = 50;
        afterEmotionSlider.value = 50;
        sessionNotesInput.value = '';
        updateSliderValue({ target: beforeEmotionSlider });
        updateSliderValue({ target: afterEmotionSlider });
    }
    
    function logCustomAction(event) {
        event.preventDefault();
        const actionName = customActionNameInput.value.trim();
        if (!actionName) {
            showMessage("Please enter a name for your custom action.");
            return;
        }
        const notes = customActionNotesInput.value.trim();
        const score = 25;
        totalPoints += score;
        sessionHistory.unshift({
            tool: actionName,
            beforeEmotion: '-',
            afterEmotion: '-',
            score: score,
            notes: notes || '-',
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Custom action logged! You earned a score of ${score}.`);
        customActionForm.reset();
    }
    
    function addReward(event) {
        event.preventDefault();
        const name = newRewardNameInput.value.trim();
        const cost = parseInt(newRewardCostInput.value, 10);
        if (!name || isNaN(cost) || cost <= 0) {
            showMessage("Please enter a valid reward name and a positive points cost.");
            return;
        }
        rewards.push({ name, cost });
        saveData();
        renderRewards();
        showMessage(`Reward "${name}" added!`);
        addRewardForm.reset();
    }
    
    function spendReward(event) {
        const index = event.target.dataset.index;
        const reward = rewards[index];
        if (totalPoints >= reward.cost) {
            totalPoints -= reward.cost;
            saveData();
            updatePointsDisplay();
            showMessage(`You spent ${reward.cost} points on: "${reward.name}". Enjoy your reward!`);
        } else {
            showMessage(`You don't have enough points. You need ${reward.cost}, but you have ${totalPoints}.`);
        }
    }
    
    function deleteReward(event) {
        const index = event.target.dataset.index;
        const rewardName = rewards[index].name;
        rewards.splice(index, 1);
        saveData();
        renderRewards();
        showMessage(`Reward "${rewardName}" has been deleted.`);
    }

    function handleDeleteSession(event) {
        if (event.target.classList.contains('delete-session-btn')) {
            const timestampToDelete = event.target.dataset.timestamp;
            sessionHistory = sessionHistory.filter(session => session.timestamp !== timestampToDelete);
            saveData();
            renderHistory();
        }
    }
    
    function downloadHistory() {
        if (sessionHistory.length === 0) {
            showMessage("No history to download yet!");
            return;
        }
        const headers = ["Timestamp", "Tool", "Before Emotion", "After Emotion", "Score", "Notes"];
        const rows = sessionHistory.map(s => [
            `"${new Date(s.timestamp).toLocaleString()}"`,
            `"${s.tool}"`, `"${s.beforeEmotion}"`, `"${s.afterEmotion}"`, `"${s.score}"`,
            `"${(s.notes || '').replace(/"/g, '""')}"`
        ].join(','));
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "dbt_companion_history.csv";
        link.click();
        URL.revokeObjectURL(link.href);
    }
    
    function toggleBreathing() {
        isBreathing = !isBreathing;
        if (isBreathing) {
            breathingCycleCount = 0;
            toggleBreathingButton.textContent = "Stop Breathing";
            const phases = ['inhale', 'hold_big', 'exhale', 'hold_small'];
            const messages = ["Inhale...", "Hold...", "Exhale...", "Hold..."];
            let phaseIndex = 0;
            
            const startNextPhase = () => {
                breathingPhase = phases[phaseIndex];
                phaseProgress = 0;
                
                if (phaseIndex === 0) { // Start of a new cycle
                    breathingCycleCount++;
                }
                breathingMessage.textContent = `${messages[phaseIndex]} (Cycle: ${breathingCycleCount})`;
                phaseIndex = (phaseIndex + 1) % 4;
            };
            
            startNextPhase();
            breathingIntervalId = setInterval(startNextPhase, phaseDuration * 1000);

        } else {
            toggleBreathingButton.textContent = "Start Breathing";
            clearInterval(breathingIntervalId);
            breathingIntervalId = null;
            breathingPhase = 'hold_small';
            sphere.material.color.set(colors.hold_small);
            sphere.scale.set(minScale, minScale, minScale);
            
            if (breathingCycleCount >= 5) {
                const score = 25;
                totalPoints += score;
                sessionHistory.unshift({
                    tool: 'Box Breathing',
                    beforeEmotion: '-', afterEmotion: '-', score,
                    notes: `Completed ${breathingCycleCount} breathing cycles.`,
                    timestamp: new Date().toISOString()
                });
                saveData();
                renderHistory();
                updatePointsDisplay();
                showMessage(`Great job! You completed ${breathingCycleCount} cycles and earned ${score} points!`);
            } else {
                 showMessage(`Session stopped. Complete 5 cycles to earn points.`);
            }
            breathingMessage.textContent = "Click below to begin.";
        }
    }
    
    function handleListSubmit(event, list, input, pointsInput, defaultPoints) {
        event.preventDefault();
        const text = input.value.trim();
        if (text) {
            const points = (pointsInput && parseInt(pointsInput.value)) || defaultPoints;
            list.push({ text, completed: false, id: Date.now(), points });
            saveData();
            renderAllLists();
            input.value = '';
            if (pointsInput) pointsInput.value = '';
        }
    }
    
    function handleListClick(event, list) {
        const target = event.target;
        const taskItem = target.closest('li');
        if (!taskItem) return;
        
        const taskId = Number(taskItem.dataset.id);
        const task = list.find(t => t.id === taskId);

        if (target.type === 'checkbox') {
            const wasCompleted = task.completed;
            task.completed = target.checked;
            if (task.completed && !wasCompleted) {
                task.completionTimestamp = new Date().toISOString();
                if (task.points > 0) {
                    totalPoints += task.points;
                    updatePointsDisplay();
                    showMessage(`Item complete! You earned ${task.points} points!`);
                }
            }
            saveData();
            renderAllLists();
        } else if (target.classList.contains('list-delete-btn')) {
            const listIndex = list.findIndex(t => t.id === taskId);
            list.splice(listIndex, 1);
            saveData();
            renderAllLists();
        }
    }

    function showAllCompletedModal() {
        const completedTasks = todoList.filter(task => task.completed)
                                     .sort((a, b) => new Date(b.completionTimestamp) - new Date(a.completionTimestamp));
        
        const groupedByDate = completedTasks.reduce((acc, task) => {
            const date = new Date(task.completionTimestamp).toLocaleDateString();
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(task);
            return acc;
        }, {});

        let modalContent = '<h2>All Completed Tasks</h2>';
        for (const date in groupedByDate) {
            modalContent += `<h3>${date}</h3><ul>`;
            groupedByDate[date].forEach(task => {
                modalContent += `<li>${task.text}</li>`;
            });
            modalContent += '</ul>';
        }
        showMessage(modalContent, true);
    }

    function setupSwiper(container, track, dots, numPanels, titleEl) {
        let currentIndex = 0;
        let touchStartX = 0;
        const titles = {
            'list-title': ["To-Do List", "Goals", "Grocery List"],
        };

        function goToPanel(index) {
            currentIndex = index;
            track.style.transform = `translateX(-${index * 100 / numPanels}%)`;
            if (titleEl) {
                titleEl.textContent = titles[titleEl.id][index];
            }
            dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
        }

        function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
        function handleTouchEnd(e) {
            const touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50 && currentIndex < numPanels - 1) {
                goToPanel(currentIndex + 1);
            }
            if (touchEndX > touchStartX + 50 && currentIndex > 0) {
                goToPanel(currentIndex - 1);
            }
        }

        dots.forEach(dot => dot.addEventListener('click', () => goToPanel(Number(dot.dataset.index))));
        container.addEventListener('touchstart', handleTouchStart);
        container.addEventListener('touchend', handleTouchEnd);
    }

    function displayDailyPrompt() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 0);
        const diff = now - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        const promptIndex = dayOfYear % stoicPrompts.length;
        journalPromptEl.innerHTML = stoicPrompts[promptIndex];
    }

    function saveJournalEntry() {
        const entryText = journalEntryInput.value.trim();
        if (!entryText) {
            showMessage("Please write something in your journal before saving.");
            return;
        }
        const promptText = journalPromptEl.textContent;
        const fullNotes = `Prompt: ${promptText}\n\nEntry: ${entryText}`;
        const score = 25;
        totalPoints += score;
        sessionHistory.unshift({
            tool: 'Journal Entry',
            beforeEmotion: '-', afterEmotion: '-', score,
            notes: fullNotes,
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Journal entry saved! You earned ${score} points.`);
        journalEntryInput.value = '';
    }
    
    function showJournalHistoryModal() {
        const journalEntries = sessionHistory.filter(s => s.tool === 'Journal Entry')
                                           .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (journalEntries.length === 0) {
            showMessage("You haven't saved any journal entries yet.");
            return;
        }

        let modalContent = '<h2>Past Journal Entries</h2>';
        journalEntries.forEach(entry => {
            const date = new Date(entry.timestamp).toLocaleDateString();
            modalContent += `<h3>${date}</h3><p style="white-space: pre-wrap;">${entry.notes}</p><hr>`;
        });
        showMessage(modalContent, true);
    }

    function backupData() {
        const dataToBackup = {
            sessionHistory, rewards, todoList, goalsList, groceryList, totalPoints,
        };
        const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dbt_companion_backup.json';
        a.click();
        URL.revokeObjectURL(url);
        localStorage.setItem(lastBackupStorageKey, new Date().toISOString());
        backupReminder.style.display = 'none';
        showMessage("Backup file created!");
    }

    function restoreData() {
        restoreFileInput.click();
    }

    function handleRestoreFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                sessionHistory = data.sessionHistory || [];
                rewards = data.rewards || [];
                todoList = data.todoList || [];
                goalsList = data.goalsList || [];
                groceryList = data.groceryList || [];
                totalPoints = data.totalPoints || 0;
                
                saveData();
                loadData(); // Reload all data and re-render the UI
                showMessage("Data restored successfully!");
            } catch (error) {
                showMessage("Error: Could not parse the backup file. It may be corrupted.");
            }
        };
        reader.readAsText(file);
    }
    
    function checkBackupReminder() {
        if (sessionStorage.getItem('backupReminderDismissed') === 'true') {
            return;
        }
        const lastBackupTimestamp = localStorage.getItem(lastBackupStorageKey);
        if (!lastBackupTimestamp) {
            backupReminder.style.display = 'flex';
            return;
        }
        const hoursSinceBackup = (new Date() - new Date(lastBackupTimestamp)) / (1000 * 60 * 60);
        if (hoursSinceBackup > 24) {
            backupReminder.style.display = 'flex';
        }
    }

    function showAffirmation() {
        const affirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
        showMessage(affirmation);
    }
    
    function showMessage(message, allowHTML = false) {
        messageBoxText[allowHTML ? 'innerHTML' : 'textContent'] = message;
        messageBox.classList.add('visible');
    }

    // --- Attach Event Listeners ---
    function attachEventListeners() {
        themeToggle.addEventListener('change', handleThemeToggle);
        toolCategoryButtons.forEach(button => button.addEventListener('click', handleCategorySelection));
        showGuideButton.addEventListener('click', showToolGuide);
        beforeEmotionSlider.addEventListener('input', updateSliderValue);
        afterEmotionSlider.addEventListener('input', updateSliderValue);
        logSessionButton.addEventListener('click', logToolSession);
        customActionForm.addEventListener('submit', logCustomAction);
        downloadHistoryButton.addEventListener('click', downloadHistory);
        historyBody.addEventListener('click', handleDeleteSession);
        affirmationFace.addEventListener('click', showAffirmation);
        toggleBreathingButton.addEventListener('click', toggleBreathing);
        addRewardForm.addEventListener('submit', addReward);
        saveJournalBtn.addEventListener('click', saveJournalEntry);
        viewJournalHistoryBtn.addEventListener('click', showJournalHistoryModal);
        
        // List Listeners
        todoForm.addEventListener('submit', (e) => handleListSubmit(e, todoList, todoInput, todoPointsInput, 10));
        goalForm.addEventListener('submit', (e) => handleListSubmit(e, goalsList, goalInput, goalPointsInput, 15));
        groceryForm.addEventListener('submit', (e) => handleListSubmit(e, groceryList, groceryInput, null, 0));
        
        pendingTasksList.addEventListener('click', (e) => handleListClick(e, todoList));
        completedTasksList.addEventListener('click', (e) => handleListClick(e, todoList));
        pendingGoalsList.addEventListener('click', (e) => handleListClick(e, goalsList));
        completedGoalsList.addEventListener('click', (e) => handleListClick(e, goalsList));
        pendingGroceriesList.addEventListener('click', (e) => handleListClick(e, groceryList));
        completedGroceriesList.addEventListener('click', (e) => handleListClick(e, groceryList));
        viewAllCompletedBtn.addEventListener('click', showAllCompletedModal);

        // Swiper Setup
        setupSwiper(listSwiperContainer, listSwiperTrack, listSwiperDots, 3, listTitle);
        
        // Navigation Listeners
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => showSection(btn.dataset.section));
        });

        // Backup & Restore Listeners
        backupBtn.addEventListener('click', backupData);
        restoreBtn.addEventListener('click', restoreData);
        restoreFileInput.addEventListener('change', handleRestoreFile);
        backupReminderBtn.addEventListener('click', backupData);
        dismissReminderBtn.addEventListener('click', () => {
            backupReminder.style.display = 'none';
            sessionStorage.setItem('backupReminderDismissed', 'true');
        });
    }

    function populateData() {
        Object.assign(dbtTools, {
            'Mindfulness': ['Observe', 'Describe', 'Participate', 'One-Mindfully', 'Non-Judgmentally', 'Effectively', 'Wise Mind'],
            'Emotional Regulation': ['CHECK THE FACTS', 'Opposite Action', 'Problem Solving', 'Accumulating Positive Emotions', 'Build Mastery', 'Cope Ahead', 'Vulnerability Reduction'],
            'Distress Tolerance': ['TIP Skill', 'ACCEPTS', 'IMPROVE', 'Pros and Cons', 'Radical Acceptance', 'Turning the Mind']
        });
        Object.assign(dbtToolGuides, {
            'Observe': '<strong>Observe:</strong> This is the foundational "What" skill of mindfulness. The goal is to simply notice your experience without getting caught up in it. Pay attention to your five senses: what can you see, hear, smell, taste, and feel right now? Also, notice the thoughts, emotions, and urges that arise within you. Imagine them as clouds passing in the sky or leaves floating down a streamâ€”just watch them come and go without judging or pushing them away.',
            'Describe': '<strong>Describe:</strong> This is the second "What" skill. After observing a thought or feeling, put words to it. Use factual, non-judgmental language. For example, instead of saying "I\'m so angry," you might describe it as: "I feel heat in my face, my fists are clenched, and the thought \'this is unfair\' is in my mind." This creates distance and reduces the intensity of the emotion.',
            'Participate': '<strong>Participate:</strong> This is the third "What" skill. It means throwing yourself completely into the current moment, becoming one with your activity. When you are walking, just walk. Feel the ground beneath your feet. When you are eating, just eat, noticing the flavors and textures. This skill helps you get out of your head and into your life, reducing self-consciousness and worry.',
            'One-Mindfully': '<strong>One-Mindfully:</strong> This is a "How" skill. It means doing one thing at a time and giving it your full attention. In a world full of distractions, this is a powerful practice. If you are talking to someone, put your phone away and just listen. If you are working, focus only on the task at hand. When your mind wanders (which it will), gently guide it back. This reduces stress and increases effectiveness.',
            'Non-Judgmentally': '<strong>Non-Judgmentally:</strong> This "How" skill involves seeing things as they are, without adding labels of "good," "bad," "right," or "wrong." Acknowledge the facts of a situation, but let go of the evaluations, blame, or criticism of yourself and others. Notice judgments as they arise and let them pass without getting attached to them. This reduces emotional suffering caused by our own evaluations.',
            'Effectively': '<strong>Effectively:</strong> This "How" skill means focusing on what works to achieve your goals in a situation. It requires letting go of being "right" or letting pride get in the way. Ask yourself: "What do I need to do to get the result I want in this situation?" It might mean following rules you don\'t like or dealing with people you find difficult, but you do it skillfully to meet your objective.',
            'Wise Mind': '<strong>Wise Mind:</strong> This is the core of mindfulness, representing the synthesis of your "Reasonable Mind" (logic, facts, planning) and your "Emotion Mind" (feelings, urges, intuition). Wise Mind is that deep, intuitive place within you that just *knows* what is true and right for you. It\'s a calm, centered state of knowing that you can access through practice, often by focusing on your breath and asking, "What does my Wise Mind say?"',
            'CHECK THE FACTS': '<strong>CHECK THE FACTS:</strong> This skill is for when you have a strong emotional reaction and you need to determine if your emotion and its intensity fit the actual facts of the situation. Ask yourself: 1. What is the emotion I\'m feeling? 2. What event prompted this emotion? 3. What are my interpretations and thoughts about the event? 4. Am I assuming a threat? 5. What are the objective facts? 6. Does my emotional intensity truly fit the facts? This helps you separate your interpretation from reality.',
            'Opposite Action': '<strong>Opposite Action:</strong> This skill is used when your emotion is unjustified by the facts, or when acting on the emotion\'s urge is not effective. You identify the urge that comes with the emotion and then do the *exact opposite*. For example, if you feel unjustified fear and the urge is to avoid, you would approach the situation. If you feel sad and the urge is to isolate, you would seek out social connection. Act opposite all the way.',
            'Problem Solving': '<strong>Problem Solving:</strong> Use this skill when the facts of a situation are the problem, and it\'s a problem that can be solved. The steps are: 1. Define the problem and your goal. 2. Brainstorm as many solutions as possible without judging them. 3. Evaluate the pros and cons of your top solutions. 4. Pick one solution and put it into action. 5. Evaluate the result. Did it work? If not, try another solution.',
            'Accumulating Positive Emotions': '<strong>Accumulating Positive Emotions:</strong> This is a long-term strategy to build a life you experience as worth living. Intentionally and mindfully engage in pleasant activities every day, even small ones. This builds up a reserve of positive feelings, making you more resilient to negative emotions when they arise. Plan positive events, and be fully present for them when they happen.',
            'Build Mastery': '<strong>Build Mastery:</strong> Actively work on a skill that makes you feel competent and effective. This could be anything from learning an instrument, practicing a sport, or getting better at your job. The feeling of mastery and accomplishment is a powerful antidote to feelings of helplessness and depression. Start small and gradually increase the challenge.',
            'Cope Ahead': '<strong>Cope Ahead:</strong> This skill helps you prepare for stressful situations you know are coming. Imagine the situation in your mind in vivid detail. Rehearse yourself coping effectively, using the DBT skills that would be most helpful. Imagine overcoming any problems that might arise. This mental rehearsal makes it more likely that you will actually cope effectively when the situation occurs.',
            'Vulnerability Reduction (PLEASE)': '<strong>Vulnerability Reduction (PLEASE):</strong> This is about taking care of your physical well-being to reduce your vulnerability to intense negative emotions. PLEASE stands for: **PL** - Treat **P**hysica**L** illness. **E** - **E**at a balanced diet. **A** - **A**void mood-altering drugs. **S** - Get enough **S**leep. **E** - Get regular **E**xercise. Tending to these basic needs creates a strong foundation for emotional stability.',
            'TIP Skill': '<strong>TIP Skill:</strong> This is a set of powerful, fast-acting skills to change your body chemistry and bring down extreme emotional arousal very quickly. **T** - **T**emperature: Use cold water on your face to trigger the dive reflex. **I** - **I**ntense Exercise: Engage in a short burst of intense physical activity. **P** - **P**aced Breathing: Slow your breathing way down, making your exhale longer than your inhale.',
            'ACCEPTS': '<strong>ACCEPTS:</strong> This is a set of distraction skills to get you through a short-term crisis without making it worse. **A** - **A**ctivities (do something). **C** - **C**ontributing (do something for someone else). **C** - **C**omparisons (compare yourself to people coping the same or less well). **E** - **E**motions (create a different emotion). **P** - **P**ushing Away (temporarily block the situation from your mind). **T** - **T**houghts (force your mind to think about something else). **S** - **S**ensations (create intense physical sensations, like holding ice).',
            'IMPROVE': '<strong>IMPROVE the moment:</strong> This is a set of self-soothing skills to make a difficult moment more tolerable. **I** - **I**magery (imagine a relaxing scene). **M** - **M**eaning (find purpose or meaning in the pain). **P** - **P**rayer (to a higher power or your own wise mind). **R** - **R**elaxation (progressive muscle relaxation, deep breathing). **O** - **O**ne thing in the moment (focus all your attention on one thing). **V** - **V**acation (take a brief break). **E** - **E**ncouragement (be your own cheerleader).',
            'Pros and Cons': '<strong>Pros and Cons:</strong> When you are in a crisis and have strong urges to engage in destructive behavior, use this skill. Make a list of the pros and cons of acting on the urge, and a list of the pros and cons of *resisting* the urge. Think about both short-term and long-term consequences. This helps you access your Wise Mind and make a more skillful decision.',
            'Radical Acceptance': '<strong>Radical Acceptance:</strong> This means completely and totally accepting reality as it is, with your mind, body, and spirit. Acceptance is not approval; it\'s acknowledging what is real so you can deal with it effectively. You stop fighting what you cannot change, which is the first step to reducing suffering. It\'s a choice you have to make over and over again.',
            'Turning the Mind': '<strong>Turning the Mind:</strong> This skill goes with Radical Acceptance. It is the conscious choice to turn your mind away from rejecting reality and toward accepting it. When you find yourself thinking "this shouldn\'t be happening," you gently but firmly say "this *is* what is happening" and turn your attention to what you need to do next. It\'s a repeated action, not a one-time fix.'
        });
        affirmations.push(...[
            "Your feelings are valid, no matter what they are.", "It's okay to need a break. You are not lazy.", "Your unique way of processing the world is a strength.", "You are worthy of love and acceptance just as you are.", "Sensory overload is a real thing, and it's okay to step away.", "Your intuition about what you need is powerful. Listen to it.", "You don't have to 'mask' to be loved or valued.", "Progress isn't always linear, and that's perfectly normal.", "Your brain works differently, and that's a beautiful thing.", "Rest is productive. Your body and mind need it.", "You are not broken. You are a complete, whole person."
        ]);
        stoicPrompts.push(...[
            "What is truly within my control today, and what is not? How can I focus my energy only on what I can control?",
            "Reflect on an obstacle you faced recently. How can you view it not as a barrier, but as an opportunity to practice a virtue like patience, courage, or wisdom?",
            "If this were my last day on Earth, how would I choose to act? What would I prioritize and what would I let go of?",
            "What external events disturbed my peace today? Why did I grant them that power over my inner tranquility?",
            "Which of the four Stoic virtues (Wisdom, Courage, Justice, Temperance) did I embody today? Where did I have an opportunity to practice one but fell short?",
            "Consider someone who frustrates you. Can you try to understand their perspective, not to excuse their actions, but to free yourself from anger?",
            "What is one thing I can do today to prepare for future challenges, making my future self more resilient? (Premeditatio Malorum)",
            "Reflect on something you often take for granted (your health, a relationship, a simple comfort). Spend a moment in genuine gratitude for it.",
            "What is an opinion or judgment I held today that caused me distress? Can I let it go and simply accept the facts of the situation?",
            "How can I act with kindness and justice toward my community and the people I interact with today?",
            "What is one desire I can willingly let go of today, to practice indifference to external things?",
            "Reflect on a past failure. What lesson did it teach me, and how has it made me stronger?",
            "Consider the vastness of time and space. How does this 'view from above' change the perspective on my current problems?",
            "What is a simple pleasure I experienced today? How can I find more joy in ordinary moments?",
            "Did I speak with purpose today, or did I engage in idle gossip or complain? How can I improve my words tomorrow?",
            "How did I respond to an unexpected event today? Did I react with emotion, or did I pause and choose a virtuous response?",
            "What aspect of nature did I notice today? How does it remind me of the natural order and flow of life?",
            "Am I living in accordance with my own values? Where is there a gap between what I believe and how I act?",
            "What is one small step I can take today to become a better version of myself?",
            "Consider your own mortality (Memento Mori). How does remembering that life is finite clarify what is truly important?",
            "What is a fear that is holding me back? What is the worst that could happen, and could I endure it?",
            "Did I contribute to the common good today, even in a small way?",
            "What is an impression I had today that I should have examined more closely before accepting it as true?",
            "How can I practice 'Amor Fati' (love of fate) and embrace everything that happened today, both good and bad, as part of my path?",
            "Where did I waste time today on things that are trivial or outside my control?",
            "What is one physical comfort I can do without for a short period, to build my resilience and appreciate it more?",
            "Think of a role model. How would they have handled the challenges I faced today?",
            "What is a commitment I made? Am I honoring it with my actions?",
            "How can I be a source of tranquility and reason for those around me today?",
            "At the end of the day, what did I learn about myself?"
        ]);
    }

    // Initial load
    initializeApp();
});
</script>

</body>
</html>
