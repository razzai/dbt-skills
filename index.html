<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My DBT Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            /* Light Mode (Default) */
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --card-bg: #f7fafc;
            --text-color: #334e68;
            --heading-color: #102a43;
            --accent-color: #5d9cec;
            --accent-light: #e6f0ff;
            --button-bg: #7cb9e8;
            --button-hover: #5d9cec;
            --affirmation-bg: #8c7ae6;
            --affirmation-hover: #7b68e0;
            --delete-button: #e87c7c;
            --delete-hover: #c45b5b;
            --neutral-color: #bcccdc;
            --border-color: #e0e6ed;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode {
            /* Dark Mode */
            --bg-color: #1a202c;
            --container-bg: #2d3748;
            --card-bg: #4a5568;
            --text-color: #e2e8f0;
            --heading-color: #f7fafc;
            --accent-color: #63b3ed;
            --accent-light: #2c5282;
            --button-bg: #4299e1;
            --button-hover: #63b3ed;
            --affirmation-bg: #9f7aea;
            --affirmation-hover: #805ad5;
            --delete-button: #f56565;
            --delete-hover: #c53030;
            --neutral-color: #718096;
            --border-color: #4a5568;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            transition: background-color 0.3s;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1, h2, h3 {
            text-align: center;
            margin: 0;
            font-weight: 700;
            color: var(--heading-color);
            transition: color 0.3s;
        }

        h1 {
            color: var(--accent-color);
            font-size: 2.25rem;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
        }
        
        h3 {
            font-size: 1.2rem;
            margin-top: 16px;
            margin-bottom: 8px;
            text-align: left;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .points-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--affirmation-bg);
            margin-bottom: 24px;
            transition: color 0.3s;
        }
        
        .tool-selection, .emotion-check, .custom-action, .history-log, .reward-system {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .tool-buttons, .specific-tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .tool-button, .button, .breathing-button, .specific-tool-button, .add-reward-button, .delete-session-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .button:disabled {
            background-color: var(--neutral-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tool-button:hover, .button:not(:disabled):hover, .breathing-button:hover, .specific-tool-button:hover, .add-reward-button:hover, .delete-session-btn:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .tool-button:active, .button:not(:disabled):active, .breathing-button:active, .specific-tool-button:active, .add-reward-button:active, .delete-session-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .delete-session-btn {
            background-color: var(--delete-button);
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        .delete-session-btn:hover {
             background-color: var(--delete-hover);
        }

        .tool-button.selected, .specific-tool-button.selected {
            background-color: var(--affirmation-bg);
        }
        
        .reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--container-bg);
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .reward-details {
            display: flex;
            flex-direction: column;
        }
        
        .reward-name {
            font-weight: 600;
        }
        
        .reward-cost {
            font-size: 0.9rem;
            color: #666;
        }

        .reward-item .button {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
        }
        
        .reward-actions {
            display: flex;
            gap: 8px;
        }

        .delete-reward-button {
            background-color: var(--delete-button);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        .delete-reward-button:hover {
            background-color: var(--delete-hover);
            transform: translateY(-2px);
        }

        .emotion-scale {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .emotion-scale label {
            font-weight: 500;
        }

        .emotion-scale input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--neutral-color);
            border-radius: 4px;
            outline: none;
            transition: opacity .2s;
        }

        .emotion-scale input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .emotion-scale .value-display {
            text-align: center;
            font-weight: 700;
        }

        .box-breathing {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        #breathing-canvas {
            width: 200px;
            height: 200px;
            cursor: pointer;
        }

        .breathing-message {
            font-weight: 500;
            min-height: 20px;
        }

        .affirmation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        .affirmation-face {
            width: 60px;
            height: 60px;
            background-color: var(--affirmation-bg);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .affirmation-face:hover {
            transform: scale(1.05);
            background-color: var(--affirmation-hover);
        }

        .affirmation-message {
            font-weight: 600;
            color: var(--text-color);
            min-height: 20px;
            max-width: 600px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        input[type="text"], textarea, input[type="number"] {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-family: inherit;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .history-log table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-log th, .history-log td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-log th {
            background-color: var(--accent-light);
            font-weight: 700;
        }

        .history-log-message {
            text-align: center;
            font-style: italic;
            color: #666;
        }
        
        .specific-tools-section {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .specific-tools-section.visible {
            display: flex;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 16px;
            text-align: center;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .message-box.visible {
            display: flex;
        }
        
        .message-box-text {
            font-weight: 500;
            font-size: 1.1rem;
            text-align: left;
        }
        
        /* Dark Mode Toggle Switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* To-Do List Styles */
        .todo-list ul {
            list-style: none;
            padding: 0;
        }
        .todo-list li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--container-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .todo-list li.completed {
            opacity: 0.6;
        }
        .todo-list li.completed span {
            text-decoration: line-through;
        }
        .todo-list li span {
            flex-grow: 1;
        }
        .todo-list input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .todo-delete-btn {
            background: var(--delete-button);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            line-height: 24px;
        }
        .todo-delete-btn:hover {
            background: var(--delete-hover);
        }

        @media (max-width: 700px) {
            .history-log table, 
            .history-log thead, 
            .history-log tbody, 
            .history-log th, 
            .history-log td, 
            .history-log tr {
                display: block;
            }

            .history-log thead {
                display: none;
            }

            .history-log tr {
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                margin-bottom: 1rem;
                background-color: var(--container-bg);
            }

            .history-log td {
                border: none;
                border-bottom: 1px solid var(--border-color);
                position: relative;
                padding-left: 50%;
                text-align: right;
                min-height: 2.5em;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            
            .history-log tr td:last-child {
                border-bottom: none;
            }

            .history-log td::before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: calc(50% - 24px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--heading-color);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <h1>My DBT Companion</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>
    <p class="points-display" id="points-display">Points: 0</p>

    <!-- Affirmation Section -->
    <div class="card affirmation-container">
        <h2>Need a Boost?</h2>
        <div class="affirmation-face" id="affirmation-face">😊</div>
        <p class="affirmation-message" id="affirmation-message">Click the face for a neuro-affirming affirmation.</p>
    </div>
    
    <!-- Box Breathing Section -->
    <div class="card box-breathing">
        <h2>Box Breathing</h2>
        <canvas id="breathing-canvas"></canvas>
        <p class="breathing-message" id="breathing-message">Click below to begin.</p>
        <button class="breathing-button" id="toggle-breathing-button">Start Breathing</button>
    </div>

    <!-- Main Tool/Emotion Logging Section -->
    <div class="card">
        <h2>Log a DBT Tool Session</h2>
        
        <div class="tool-selection">
            <p>1. Select the tool category you used:</p>
            <div class="tool-buttons" id="tool-category-buttons">
                <button class="tool-button" data-tool="Mindfulness">Mindfulness</button>
                <button class="tool-button" data-tool="Emotional Regulation">Emotional Regulation</button>
                <button class="tool-button" data-tool="Distress Tolerance">Distress Tolerance</button>
            </div>
        </div>
        
        <div class="specific-tools-section" id="specific-tools-section">
            <p>2. Select the specific tool you used:</p>
            <div class="specific-tool-buttons" id="specific-tool-buttons"></div>
            <button class="button" id="show-guide-button" disabled>Show Guide</button>
        </div>

        <div class="emotion-check">
            <p>3. How did you feel before and after?</p>
            <div class="emotion-scale">
                <label for="before-emotion">Before Session</label>
                <input type="range" id="before-emotion" min="0" max="100" value="50">
                <p class="value-display" id="before-value">Feeling Score: 50</p>
            </div>
            <div class="emotion-scale">
                <label for="after-emotion">After Session</label>
                <input type="range" id="after-emotion" min="0" max="100" value="50">
                <p class="value-display" id="after-value">Feeling Score: 50</p>
            </div>
        </div>
        <p>4. Add some notes (optional):</p>
        <textarea id="session-notes" placeholder="Any thoughts, feelings, or observations..."></textarea>
        <button class="button" id="log-session" style="margin-top: 16px;">Log Session</button>
    </div>

    <!-- Custom Action Section -->
    <div class="card custom-action">
        <h2>Log a Custom Action</h2>
        <form id="custom-action-form">
            <p>What did you do?</p>
            <input type="text" id="custom-action-name" placeholder="E.g., Took a walk" required>
            <p>Add some notes:</p>
            <textarea id="custom-action-notes" placeholder="Any thoughts..."></textarea>
            <button class="button" type="submit">Log Custom Action</button>
        </form>
    </div>

    <!-- Reward System Section -->
    <div class="card reward-system">
        <h2>My Rewards</h2>
        <form id="add-reward-form">
            <input type="text" id="new-reward-name" placeholder="Reward name" required>
            <input type="number" id="new-reward-cost" placeholder="Points cost" min="1" required>
            <button class="add-reward-button" type="submit">Add Reward</button>
        </form>
        <div id="rewards-list">
            <p id="no-rewards-message" style="text-align:center; font-style:italic;">No rewards added yet.</p>
        </div>
    </div>

    <!-- To-Do List Section -->
    <div class="card todo-list">
        <h2>To-Do List</h2>
        <form id="todo-form">
            <input type="text" id="todo-input" placeholder='E.g., "Wash one dish" or "Open email"' required>
            <button class="button" type="submit" style="width: 100%; margin-top: 8px;">Add Task</button>
        </form>
        
        <h3>To Do</h3>
        <ul id="pending-tasks"></ul>
        
        <h3>Completed</h3>
        <ul id="completed-tasks"></ul>
    </div>


    <!-- History Log Section -->
    <div class="card history-log">
        <h2>Session History</h2>
        <div class="history-table-container">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Tool</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Score</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
        <button class="button" id="download-history">Download History (CSV)</button>
    </div>
</div>

<!-- Message Box -->
<div class="message-box" id="message-box">
    <p class="message-box-text" id="message-box-text"></p>
    <button class="button" onclick="document.getElementById('message-box').classList.remove('visible')">Close</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements & Global Variables ---
    const themeToggle = document.getElementById('checkbox');
    const pointsDisplay = document.getElementById('points-display');
    const toolCategoryButtons = document.querySelectorAll('.tool-button');
    const specificToolsSection = document.getElementById('specific-tools-section');
    const specificToolButtonsContainer = document.getElementById('specific-tool-buttons');
    const showGuideButton = document.getElementById('show-guide-button');
    const beforeEmotionSlider = document.getElementById('before-emotion');
    const afterEmotionSlider = document.getElementById('after-emotion');
    const beforeValueDisplay = document.getElementById('before-value');
    const afterValueDisplay = document.getElementById('after-value');
    const logSessionButton = document.getElementById('log-session');
    const sessionNotesInput = document.getElementById('session-notes');
    const customActionForm = document.getElementById('custom-action-form');
    const customActionNameInput = document.getElementById('custom-action-name');
    const customActionNotesInput = document.getElementById('custom-action-notes');
    const historyBody = document.getElementById('history-body');
    const downloadHistoryButton = document.getElementById('download-history');
    const affirmationFace = document.getElementById('affirmation-face');
    const breathingCanvas = document.getElementById('breathing-canvas');
    const breathingMessage = document.getElementById('breathing-message');
    const toggleBreathingButton = document.getElementById('toggle-breathing-button');
    const messageBox = document.getElementById('message-box');
    const messageBoxText = document.getElementById('message-box-text');
    const addRewardForm = document.getElementById('add-reward-form');
    const newRewardNameInput = document.getElementById('new-reward-name');
    const newRewardCostInput = document.getElementById('new-reward-cost');
    const rewardsList = document.getElementById('rewards-list');
    const todoForm = document.getElementById('todo-form');
    const todoInput = document.getElementById('todo-input');
    const pendingTasksList = document.getElementById('pending-tasks');
    const completedTasksList = document.getElementById('completed-tasks');

    let selectedTool = null;
    let sessionHistory = [];
    let rewards = [];
    let todoList = [];
    let totalPoints = 0;
    let isBreathing = false;
    let breathingIntervalId = null;
    let breathingCycleCount = 0;
    const historyStorageKey = 'dbt-companion-history';
    const rewardsStorageKey = 'dbt-companion-rewards';
    const pointsStorageKey = 'dbt-companion-points';
    const themeStorageKey = 'dbt-companion-theme';
    const todoStorageKey = 'dbt-companion-todo';

    // --- Data (will be populated later) ---
    const dbtTools = {};
    const dbtToolGuides = {};
    const affirmations = [];

    // --- Three.js Breathing Animation Variables ---
    let scene, camera, renderer, sphere;
    let breathingPhase = 'hold_small'; 
    let phaseProgress = 0; 
    const phaseDuration = 4; 
    const clock = new THREE.Clock();
    const minScale = 1.0;
    const maxScale = 1.5;
    const colors = {
        inhale: new THREE.Color(0x63b3ed),
        hold_big: new THREE.Color(0x9f7aea),
        exhale: new THREE.Color(0x48bb78),
        hold_small: new THREE.Color(0xa0aec0)
    };

    // --- Initialization ---
    function initializeApp() {
        populateData();
        loadTheme();
        loadData();
        initThreeJS();
        attachEventListeners();
    }

    // --- Three.js Setup and Animation ---
    function initThreeJS() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, breathingCanvas.clientWidth / breathingCanvas.clientHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ canvas: breathingCanvas, antialias: true, alpha: true });
        renderer.setSize(breathingCanvas.clientWidth, breathingCanvas.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshStandardMaterial({ color: colors.hold_small, metalness: 0.3, roughness: 0.4 });
        sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 0.8);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);
        camera.position.z = 3;
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        const deltaTime = clock.getDelta();
        if (isBreathing) {
            phaseProgress += deltaTime / phaseDuration;
            let currentScale, startColor, endColor;
            switch (breathingPhase) {
                case 'inhale': currentScale = THREE.MathUtils.lerp(minScale, maxScale, phaseProgress); startColor = colors.hold_small; endColor = colors.inhale; break;
                case 'hold_big': currentScale = maxScale; startColor = colors.inhale; endColor = colors.hold_big; break;
                case 'exhale': currentScale = THREE.MathUtils.lerp(maxScale, minScale, phaseProgress); startColor = colors.hold_big; endColor = colors.exhale; break;
                case 'hold_small': currentScale = minScale; startColor = colors.exhale; endColor = colors.hold_small; break;
            }
            sphere.scale.set(currentScale, currentScale, currentScale);
            sphere.material.color.lerpColors(startColor, endColor, phaseProgress);
        }
        sphere.rotation.y += 0.001;
        renderer.render(scene, camera);
    }
    
    // --- Theme Management ---
    function loadTheme() {
        const isDarkMode = localStorage.getItem(themeStorageKey) === 'true';
        themeToggle.checked = isDarkMode;
        if (isDarkMode) document.body.classList.add('dark-mode');
    }

    function handleThemeToggle() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem(themeStorageKey, themeToggle.checked);
    }

    // --- Core Functions (Data, Rendering, etc.) ---
    function loadData() {
        sessionHistory = JSON.parse(localStorage.getItem(historyStorageKey)) || [];
        rewards = JSON.parse(localStorage.getItem(rewardsStorageKey)) || [];
        todoList = JSON.parse(localStorage.getItem(todoStorageKey)) || [];
        totalPoints = parseInt(localStorage.getItem(pointsStorageKey), 10) || 0;
        renderHistory();
        renderRewards();
        renderTodoList();
        updatePointsDisplay();
    }
    
    function saveData() {
        localStorage.setItem(historyStorageKey, JSON.stringify(sessionHistory));
        localStorage.setItem(rewardsStorageKey, JSON.stringify(rewards));
        localStorage.setItem(pointsStorageKey, totalPoints);
        localStorage.setItem(todoStorageKey, JSON.stringify(todoList));
    }
    
    function updatePointsDisplay() {
        pointsDisplay.textContent = `Points: ${totalPoints}`;
    }
    
    function calculateScore(tool, before, after) {
        let baseScore = 50;
        if (tool === 'Box Breathing') baseScore = 25;
        const emotionBonus = Math.max(0, after - before);
        return baseScore + emotionBonus;
    }
    
    function renderHistory() {
        if (sessionHistory.length === 0) {
            historyBody.innerHTML = `<tr><td colspan="7" class="history-log-message">No sessions logged yet.</td></tr>`;
            return;
        }
        const html = sessionHistory.map(session => {
            const formattedDate = new Date(session.timestamp).toLocaleString();
            return `
                <tr>
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Tool">${session.tool}</td>
                    <td data-label="Before">${session.beforeEmotion}</td>
                    <td data-label="After">${session.afterEmotion}</td>
                    <td data-label="Score">${session.score}</td>
                    <td data-label="Notes">${session.notes || '-'}</td>
                    <td data-label="Actions"><button class="delete-session-btn" data-timestamp="${session.timestamp}">Delete</button></td>
                </tr>
            `;
        }).join('');
        historyBody.innerHTML = html;
    }
    
    function renderRewards() {
        if (rewards.length === 0) {
            rewardsList.innerHTML = `<p id="no-rewards-message" style="text-align:center; font-style:italic;">No rewards added yet.</p>`;
            return;
        }
        rewardsList.innerHTML = '';
        rewards.forEach((reward, index) => {
            const rewardItem = document.createElement('div');
            rewardItem.classList.add('reward-item');
            rewardItem.innerHTML = `
                <div class="reward-details">
                    <span class="reward-name">${reward.name}</span>
                    <span class="reward-cost">Cost: ${reward.cost} points</span>
                </div>
                <div class="reward-actions">
                    <button class="button spend-reward" data-index="${index}">Spend</button>
                    <button class="delete-reward-button" data-index="${index}">Delete</button>
                </div>
            `;
            rewardsList.appendChild(rewardItem);
        });
        document.querySelectorAll('.spend-reward').forEach(b => b.addEventListener('click', spendReward));
        document.querySelectorAll('.delete-reward-button').forEach(b => b.addEventListener('click', deleteReward));
    }

    function renderTodoList() {
        pendingTasksList.innerHTML = '';
        completedTasksList.innerHTML = '';
        todoList.forEach(task => {
            const taskItem = document.createElement('li');
            taskItem.dataset.id = task.id;
            taskItem.innerHTML = `
                <input type="checkbox" ${task.completed ? 'checked' : ''}>
                <span>${task.text}</span>
                <button class="todo-delete-btn">X</button>
            `;
            if (task.completed) {
                taskItem.classList.add('completed');
                completedTasksList.appendChild(taskItem);
            } else {
                pendingTasksList.appendChild(taskItem);
            }
        });
    }
    
    // --- Event Handlers ---
    function handleCategorySelection(event) {
        toolCategoryButtons.forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedCategory = event.target.dataset.tool;
        selectedTool = null;
        showGuideButton.disabled = true;
        renderSpecificTools(selectedCategory);
    }
    
    function renderSpecificTools(category) {
        const tools = dbtTools[category] || [];
        specificToolButtonsContainer.innerHTML = tools.map(tool => `<button class="specific-tool-button" data-tool="${tool}">${tool}</button>`).join('');
        specificToolsSection.classList.add('visible');
        document.querySelectorAll('.specific-tool-button').forEach(button => button.addEventListener('click', handleToolSelection));
    }
    
    function handleToolSelection(event) {
        document.querySelectorAll('.specific-tool-button').forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedTool = event.target.dataset.tool;
        showGuideButton.disabled = false;
    }
    
    function showToolGuide() {
        if (selectedTool && dbtToolGuides[selectedTool]) {
            showMessage(dbtToolGuides[selectedTool], true);
        } else {
            showMessage("Please select a specific tool first to see its guide.", false);
        }
    }
    
    function updateSliderValue(event) {
        const displayElement = event.target.id === 'before-emotion' ? beforeValueDisplay : afterValueDisplay;
        displayElement.textContent = `Feeling Score: ${event.target.value}`;
    }
    
    function logToolSession() {
        if (!selectedTool) {
            showMessage("Please select a specific DBT tool before logging.");
            return;
        }
        const before = parseInt(beforeEmotionSlider.value);
        const after = parseInt(afterEmotionSlider.value);
        const notes = sessionNotesInput.value.trim();
        const score = calculateScore(selectedTool, before, after);
        totalPoints += score;
        sessionHistory.unshift({
            tool: selectedTool,
            beforeEmotion: before,
            afterEmotion: after,
            score: score,
            notes: notes || '-',
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Session logged! You earned a score of ${score}.`);
        
        // Reset form
        toolCategoryButtons.forEach(btn => btn.classList.remove('selected'));
        specificToolsSection.classList.remove('visible');
        selectedCategory = null;
        selectedTool = null;
        showGuideButton.disabled = true;
        beforeEmotionSlider.value = 50;
        afterEmotionSlider.value = 50;
        sessionNotesInput.value = '';
        updateSliderValue({ target: beforeEmotionSlider });
        updateSliderValue({ target: afterEmotionSlider });
    }
    
    function logCustomAction(event) {
        event.preventDefault();
        const actionName = customActionNameInput.value.trim();
        if (!actionName) {
            showMessage("Please enter a name for your custom action.");
            return;
        }
        const notes = customActionNotesInput.value.trim();
        const score = 25;
        totalPoints += score;
        sessionHistory.unshift({
            tool: actionName,
            beforeEmotion: '-',
            afterEmotion: '-',
            score: score,
            notes: notes || '-',
            timestamp: new Date().toISOString()
        });
        saveData();
        renderHistory();
        updatePointsDisplay();
        showMessage(`Custom action logged! You earned a score of ${score}.`);
        customActionForm.reset();
    }
    
    function addReward(event) {
        event.preventDefault();
        const name = newRewardNameInput.value.trim();
        const cost = parseInt(newRewardCostInput.value, 10);
        if (!name || isNaN(cost) || cost <= 0) {
            showMessage("Please enter a valid reward name and a positive points cost.");
            return;
        }
        rewards.push({ name, cost });
        saveData();
        renderRewards();
        showMessage(`Reward "${name}" added!`);
        addRewardForm.reset();
    }
    
    function spendReward(event) {
        const index = event.target.dataset.index;
        const reward = rewards[index];
        if (totalPoints >= reward.cost) {
            totalPoints -= reward.cost;
            saveData();
            updatePointsDisplay();
            showMessage(`You spent ${reward.cost} points on: "${reward.name}". Enjoy your reward!`);
        } else {
            showMessage(`You don't have enough points. You need ${reward.cost}, but you have ${totalPoints}.`);
        }
    }
    
    function deleteReward(event) {
        const index = event.target.dataset.index;
        const rewardName = rewards[index].name;
        rewards.splice(index, 1);
        saveData();
        renderRewards();
        showMessage(`Reward "${rewardName}" has been deleted.`);
    }

    function handleDeleteSession(event) {
        if (event.target.classList.contains('delete-session-btn')) {
            const timestampToDelete = event.target.dataset.timestamp;
            sessionHistory = sessionHistory.filter(session => session.timestamp !== timestampToDelete);
            saveData();
            renderHistory();
        }
    }
    
    function downloadHistory() {
        if (sessionHistory.length === 0) {
            showMessage("No history to download yet!");
            return;
        }
        const headers = ["Timestamp", "Tool", "Before Emotion", "After Emotion", "Score", "Notes"];
        const rows = sessionHistory.map(s => [
            `"${new Date(s.timestamp).toLocaleString()}"`,
            `"${s.tool}"`, `"${s.beforeEmotion}"`, `"${s.afterEmotion}"`, `"${s.score}"`,
            `"${(s.notes || '').replace(/"/g, '""')}"`
        ].join(','));
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "dbt_companion_history.csv";
        link.click();
        URL.revokeObjectURL(link.href);
    }
    
    function toggleBreathing() {
        isBreathing = !isBreathing;
        if (isBreathing) {
            breathingCycleCount = 0;
            toggleBreathingButton.textContent = "Stop Breathing";
            const phases = ['inhale', 'hold_big', 'exhale', 'hold_small'];
            const messages = ["Inhale...", "Hold...", "Exhale...", "Hold..."];
            let phaseIndex = 0;
            
            const startNextPhase = () => {
                breathingPhase = phases[phaseIndex];
                phaseProgress = 0;
                
                if (phaseIndex === 0) { // Start of a new cycle
                    breathingCycleCount++;
                }
                breathingMessage.textContent = `${messages[phaseIndex]} (Cycle: ${breathingCycleCount})`;
                phaseIndex = (phaseIndex + 1) % 4;
            };
            
            startNextPhase();
            breathingIntervalId = setInterval(startNextPhase, phaseDuration * 1000);

        } else {
            toggleBreathingButton.textContent = "Start Breathing";
            clearInterval(breathingIntervalId);
            breathingIntervalId = null;
            breathingPhase = 'hold_small';
            sphere.material.color.set(colors.hold_small);
            sphere.scale.set(minScale, minScale, minScale);
            
            if (breathingCycleCount >= 5) {
                const score = 25;
                totalPoints += score;
                sessionHistory.unshift({
                    tool: 'Box Breathing',
                    beforeEmotion: '-', afterEmotion: '-', score,
                    notes: `Completed ${breathingCycleCount} breathing cycles.`,
                    timestamp: new Date().toISOString()
                });
                saveData();
                renderHistory();
                updatePointsDisplay();
                showMessage(`Great job! You completed ${breathingCycleCount} cycles and earned ${score} points!`);
            } else {
                 showMessage(`Session stopped. Complete 5 cycles to earn points.`);
            }
            breathingMessage.textContent = "Click below to begin.";
        }
    }
    
    function handleTodoSubmit(event) {
        event.preventDefault();
        const text = todoInput.value.trim();
        if (text) {
            todoList.push({ text, completed: false, id: Date.now() });
            saveData();
            renderTodoList();
            todoInput.value = '';
        }
    }
    
    function handleTodoListClick(event) {
        const target = event.target;
        const taskItem = target.closest('li');
        if (!taskItem) return;
        
        const taskId = Number(taskItem.dataset.id);
        const task = todoList.find(t => t.id === taskId);

        if (target.type === 'checkbox') {
            task.completed = target.checked;
            if (task.completed) {
                totalPoints += 10;
                updatePointsDisplay();
                showMessage("Task complete! You earned 10 points!");
            }
            saveData();
            renderTodoList();
        } else if (target.classList.contains('todo-delete-btn')) {
            todoList = todoList.filter(t => t.id !== taskId);
            saveData();
            renderTodoList();
        }
    }

    function showAffirmation() {
        const affirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
        showMessage(affirmation);
    }
    
    function showMessage(message, allowHTML = false) {
        messageBoxText[allowHTML ? 'innerHTML' : 'textContent'] = message;
        messageBox.classList.add('visible');
    }

    // --- Attach Event Listeners ---
    function attachEventListeners() {
        themeToggle.addEventListener('change', handleThemeToggle);
        toolCategoryButtons.forEach(button => button.addEventListener('click', handleCategorySelection));
        showGuideButton.addEventListener('click', showToolGuide);
        beforeEmotionSlider.addEventListener('input', updateSliderValue);
        afterEmotionSlider.addEventListener('input', updateSliderValue);
        logSessionButton.addEventListener('click', logToolSession);
        customActionForm.addEventListener('submit', logCustomAction);
        downloadHistoryButton.addEventListener('click', downloadHistory);
        historyBody.addEventListener('click', handleDeleteSession);
        affirmationFace.addEventListener('click', showAffirmation);
        toggleBreathingButton.addEventListener('click', toggleBreathing);
        addRewardForm.addEventListener('submit', addReward);
        todoForm.addEventListener('submit', handleTodoSubmit);
        pendingTasksList.addEventListener('click', handleTodoListClick);
        completedTasksList.addEventListener('click', handleTodoListClick);
    }

    function populateData() {
        Object.assign(dbtTools, {
            'Mindfulness': ['Observe', 'Describe', 'Participate', 'One-Mindfully', 'Non-Judgmentally', 'Effectively', 'Wise Mind'],
            'Emotional Regulation': ['CHECK THE FACTS', 'Opposite Action', 'Problem Solving', 'Accumulating Positive Emotions', 'Build Mastery', 'Cope Ahead', 'Vulnerability Reduction'],
            'Distress Tolerance': ['TIP Skill', 'ACCEPTS', 'IMPROVE', 'Pros and Cons', 'Radical Acceptance', 'Turning the Mind']
        });
        Object.assign(dbtToolGuides, {
            'Observe': '<strong>Observe:</strong> This is the foundational "What" skill of mindfulness. The goal is to simply notice your experience without getting caught up in it. Pay attention to your five senses: what can you see, hear, smell, taste, and feel right now? Also, notice the thoughts, emotions, and urges that arise within you. Imagine them as clouds passing in the sky or leaves floating down a stream—just watch them come and go without judging or pushing them away.',
            'Describe': '<strong>Describe:</strong> This is the second "What" skill. After observing a thought or feeling, put words to it. Use factual, non-judgmental language. For example, instead of saying "I\'m so angry," you might describe it as: "I feel heat in my face, my fists are clenched, and the thought \'this is unfair\' is in my mind." This creates distance and reduces the intensity of the emotion.',
            'Participate': '<strong>Participate:</strong> This is the third "What" skill. It means throwing yourself completely into the current moment, becoming one with your activity. When you are walking, just walk. Feel the ground beneath your feet. When you are eating, just eat, noticing the flavors and textures. This skill helps you get out of your head and into your life, reducing self-consciousness and worry.',
            'One-Mindfully': '<strong>One-Mindfully:</strong> This is a "How" skill. It means doing one thing at a time and giving it your full attention. In a world full of distractions, this is a powerful practice. If you are talking to someone, put your phone away and just listen. If you are working, focus only on the task at hand. When your mind wanders (which it will), gently guide it back. This reduces stress and increases effectiveness.',
            'Non-Judgmentally': '<strong>Non-Judgmentally:</strong> This "How" skill involves seeing things as they are, without adding labels of "good," "bad," "right," or "wrong." Acknowledge the facts of a situation, but let go of the evaluations, blame, or criticism of yourself and others. Notice judgments as they arise and let them pass without getting attached to them. This reduces emotional suffering caused by our own evaluations.',
            'Effectively': '<strong>Effectively:</strong> This "How" skill means focusing on what works to achieve your goals in a situation. It requires letting go of being "right" or letting pride get in the way. Ask yourself: "What do I need to do to get the result I want in this situation?" It might mean following rules you don\'t like or dealing with people you find difficult, but you do it skillfully to meet your objective.',
            'Wise Mind': '<strong>Wise Mind:</strong> This is the core of mindfulness, representing the synthesis of your "Reasonable Mind" (logic, facts, planning) and your "Emotion Mind" (feelings, urges, intuition). Wise Mind is that deep, intuitive place within you that just *knows* what is true and right for you. It\'s a calm, centered state of knowing that you can access through practice, often by focusing on your breath and asking, "What does my Wise Mind say?"',
            'CHECK THE FACTS': '<strong>CHECK THE FACTS:</strong> This skill is for when you have a strong emotional reaction and you need to determine if your emotion and its intensity fit the actual facts of the situation. Ask yourself: 1. What is the emotion I\'m feeling? 2. What event prompted this emotion? 3. What are my interpretations and thoughts about the event? 4. Am I assuming a threat? 5. What are the objective facts? 6. Does my emotional intensity truly fit the facts? This helps you separate your interpretation from reality.',
            'Opposite Action': '<strong>Opposite Action:</strong> This skill is used when your emotion is unjustified by the facts, or when acting on the emotion\'s urge is not effective. You identify the urge that comes with the emotion and then do the *exact opposite*. For example, if you feel unjustified fear and the urge is to avoid, you would approach the situation. If you feel sad and the urge is to isolate, you would seek out social connection. Act opposite all the way.',
            'Problem Solving': '<strong>Problem Solving:</strong> Use this skill when the facts of a situation are the problem, and it\'s a problem that can be solved. The steps are: 1. Define the problem and your goal. 2. Brainstorm as many solutions as possible without judging them. 3. Evaluate the pros and cons of your top solutions. 4. Pick one solution and put it into action. 5. Evaluate the result. Did it work? If not, try another solution.',
            'Accumulating Positive Emotions': '<strong>Accumulating Positive Emotions:</strong> This is a long-term strategy to build a life you experience as worth living. Intentionally and mindfully engage in pleasant activities every day, even small ones. This builds up a reserve of positive feelings, making you more resilient to negative emotions when they arise. Plan positive events, and be fully present for them when they happen.',
            'Build Mastery': '<strong>Build Mastery:</strong> Actively work on a skill that makes you feel competent and effective. This could be anything from learning an instrument, practicing a sport, or getting better at your job. The feeling of mastery and accomplishment is a powerful antidote to feelings of helplessness and depression. Start small and gradually increase the challenge.',
            'Cope Ahead': '<strong>Cope Ahead:</strong> This skill helps you prepare for stressful situations you know are coming. Imagine the situation in your mind in vivid detail. Rehearse yourself coping effectively, using the DBT skills that would be most helpful. Imagine overcoming any problems that might arise. This mental rehearsal makes it more likely that you will actually cope effectively when the situation occurs.',
            'Vulnerability Reduction (PLEASE)': '<strong>Vulnerability Reduction (PLEASE):</strong> This is about taking care of your physical well-being to reduce your vulnerability to intense negative emotions. PLEASE stands for: **PL** - Treat **P**hysica**L** illness. **E** - **E**at a balanced diet. **A** - **A**void mood-altering drugs. **S** - Get enough **S**leep. **E** - Get regular **E**xercise. Tending to these basic needs creates a strong foundation for emotional stability.',
            'TIP Skill': '<strong>TIP Skill:</strong> This is a set of powerful, fast-acting skills to change your body chemistry and bring down extreme emotional arousal very quickly. **T** - **T**emperature: Use cold water on your face to trigger the dive reflex. **I** - **I**ntense Exercise: Engage in a short burst of intense physical activity. **P** - **P**aced Breathing: Slow your breathing way down, making your exhale longer than your inhale.',
            'ACCEPTS': '<strong>ACCEPTS:</strong> This is a set of distraction skills to get you through a short-term crisis without making it worse. **A** - **A**ctivities (do something). **C** - **C**ontributing (do something for someone else). **C** - **C**omparisons (compare yourself to people coping the same or less well). **E** - **E**motions (create a different emotion). **P** - **P**ushing Away (temporarily block the situation from your mind). **T** - **T**houghts (force your mind to think about something else). **S** - **S**ensations (create intense physical sensations, like holding ice).',
            'IMPROVE': '<strong>IMPROVE the moment:</strong> This is a set of self-soothing skills to make a difficult moment more tolerable. **I** - **I**magery (imagine a relaxing scene). **M** - **M**eaning (find purpose or meaning in the pain). **P** - **P**rayer (to a higher power or your own wise mind). **R** - **R**elaxation (progressive muscle relaxation, deep breathing). **O** - **O**ne thing in the moment (focus all your attention on one thing). **V** - **V**acation (take a brief break). **E** - **E**ncouragement (be your own cheerleader).',
            'Pros and Cons': '<strong>Pros and Cons:</strong> When you are in a crisis and have strong urges to engage in destructive behavior, use this skill. Make a list of the pros and cons of acting on the urge, and a list of the pros and cons of *resisting* the urge. Think about both short-term and long-term consequences. This helps you access your Wise Mind and make a more skillful decision.',
            'Radical Acceptance': '<strong>Radical Acceptance:</strong> This means completely and totally accepting reality as it is, with your mind, body, and spirit. Acceptance is not approval; it\'s acknowledging what is real so you can deal with it effectively. You stop fighting what you cannot change, which is the first step to reducing suffering. It\'s a choice you have to make over and over again.',
            'Turning the Mind': '<strong>Turning the Mind:</strong> This skill goes with Radical Acceptance. It is the conscious choice to turn your mind away from rejecting reality and toward accepting it. When you find yourself thinking "this shouldn\'t be happening," you gently but firmly say "this *is* what is happening" and turn your attention to what you need to do next. It\'s a repeated action, not a one-time fix.'
        });
        affirmations.push(...[
            "Your feelings are valid, no matter what they are.", "It's okay to need a break. You are not lazy.", "Your unique way of processing the world is a strength.", "You are worthy of love and acceptance just as you are.", "Sensory overload is a real thing, and it's okay to step away.", "Your intuition about what you need is powerful. Listen to it.", "You don't have to 'mask' to be loved or valued.", "Progress isn't always linear, and that's perfectly normal.", "Your brain works differently, and that's a beautiful thing.", "Rest is productive. Your body and mind need it.", "You are not broken. You are a complete, whole person."
        ]);
    }

    // Initial load
    initializeApp();
});
</script>

</body>
</html>
